# æ•°æ®æ ‡æ³¨å›­åŒºè®¿å®¢ç®¡ç†ç³»ç»Ÿéœ€æ±‚åˆ†ææŠ¥å‘Š

> ğŸ“Œ **åˆ†ææ–¹æ³•**: Sequential Thinkingæ·±åº¦åˆ†æ  
> ğŸ“… **åˆ†ææ—¥æœŸ**: 2025-11-27  
> ğŸ¯ **åˆ†æé‡ç‚¹**: é—¨ç¦é›†æˆã€æ¶ˆæ¯æ¨é€ã€æ•°æ®å®‰å…¨ + MVPèŒƒå›´ + å¼€å‘å‘¨æœŸä¼°ç®—

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ä¸€ç³»ç»Ÿæ¦‚è¿°)
2. [ä¸šåŠ¡æµç¨‹åˆ†æ](#äºŒä¸šåŠ¡æµç¨‹åˆ†æ)
3. [ä¸‰å¤§æŠ€æœ¯éš¾ç‚¹æ·±åº¦åˆ†æ](#ä¸‰ä¸‰å¤§æŠ€æœ¯éš¾ç‚¹æ·±åº¦åˆ†æ)
4. [MVPèŒƒå›´å»ºè®®](#å››mvpèŒƒå›´å»ºè®®)
5. [æŠ€æœ¯æ¶æ„è®¾è®¡](#äº”æŠ€æœ¯æ¶æ„è®¾è®¡)
6. [å¼€å‘å‘¨æœŸä¼°ç®—](#å…­å¼€å‘å‘¨æœŸä¼°ç®—)
7. [éåŠŸèƒ½éœ€æ±‚é‡åŒ–](#ä¸ƒéåŠŸèƒ½éœ€æ±‚é‡åŒ–)
8. [é£é™©è¯„ä¼°ä¸åº”å¯¹](#å…«é£é™©è¯„ä¼°ä¸åº”å¯¹)
9. [æˆåŠŸæ ‡å‡†](#ä¹æˆåŠŸæ ‡å‡†)
10. [æˆæœ¬ä¼°ç®—](#åæˆæœ¬ä¼°ç®—)

---

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 ä¸šåŠ¡åœºæ™¯

æ•°æ®æ ‡æ³¨å›­åŒºè®¿å®¢å…¨æµç¨‹çº¿ä¸ŠåŒ–ç®¡ç†ç³»ç»Ÿ,æ ¸å¿ƒä¸šåŠ¡æµç¨‹:

```mermaid
graph LR
    A[è®¿å®¢é¢„çº¦ç”³è¯·] --> B[è¢«è®¿äººå®¡æ‰¹]
    B --> C[ä¸»ç®¡/å®‰ä¿å®¡æ‰¹]
    C --> D[é—¨ç¦æƒé™ä¸‹å‘]
    D --> E[è®¿å®¢ç­¾åˆ°]
    E --> F[è®¿é—®æœŸé—´]
    F --> G[è®¿å®¢ç­¾é€€]
    G --> H[æƒé™å›æ”¶]
    H --> I[æ•°æ®ç»Ÿè®¡åˆ†æ]
```

### 1.2 æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç»´åº¦ | ç°çŠ¶ç—›ç‚¹ | ç³»ç»Ÿä»·å€¼ | é‡åŒ–æŒ‡æ ‡ |
|----------|----------|----------|----------|
| æ•ˆç‡æå‡ | çº¸è´¨ç™»è®°,å¹³å‡5åˆ†é’Ÿ/äºº | çº¿ä¸Šé¢„çº¦,30ç§’å®Œæˆ | æ•ˆç‡æå‡90% |
| å®‰å…¨ç®¡æ§ | æ‰‹åŠ¨å½•å…¥é—¨ç¦,é”™è¯¯ç‡20% | è‡ªåŠ¨åŒ–ä¸‹å‘,å®æ—¶åŒæ­¥ | é”™è¯¯ç‡é™è‡³5%ä»¥ä¸‹ |
| æ•°æ®è¿½æº¯ | çº¸è´¨è®°å½•éš¾æŸ¥è¯¢ | å…¨ç”µå­åŒ–,ç§’çº§æŸ¥è¯¢ | æŸ¥è¯¢æ•ˆç‡æå‡100å€ |
| äººåŠ›æˆæœ¬ | éœ€2åå‰å°ä¸“èŒç™»è®° | è‡ªåŠ©åŒ–,é‡Šæ”¾1åäººåŠ› | äººåŠ›æˆæœ¬é™ä½50% |

### 1.3 ç³»ç»Ÿå®šä½

- **ç³»ç»Ÿç±»å‹**: ä¼ä¸šçº§è®¿å®¢ç®¡ç†SaaSç³»ç»Ÿ
- **ç”¨æˆ·è§„æ¨¡**: æ—¥æ´»200-300è®¿å®¢,100å‘˜å·¥å¹¶å‘
- **æŠ€æœ¯å¤æ‚åº¦**: â­â­â­â­ (4æ˜Ÿ,é—¨ç¦é›†æˆä¸ºæ ¸å¿ƒéš¾ç‚¹)
- **ä¸šåŠ¡å¤æ‚åº¦**: â­â­â­ (3æ˜Ÿ,å®¡æ‰¹æµç¨‹æ ‡å‡†åŒ–)

---

## äºŒã€ä¸šåŠ¡æµç¨‹åˆ†æ

### 2.1 å®Œæ•´ä¸šåŠ¡æµç¨‹

#### é˜¶æ®µ1: é¢„çº¦ç”³è¯·(è®¿å®¢ç«¯)
1. è®¿å®¢é€šè¿‡å¾®ä¿¡å…¬ä¼—å·è¿›å…¥é¢„çº¦é¡µé¢
2. å¡«å†™ä¸ªäººä¿¡æ¯(å§“åã€æ‰‹æœºã€èº«ä»½è¯ã€ç…§ç‰‡)
3. å¡«å†™è®¿é—®ä¿¡æ¯(æ¥è®¿ç›®çš„ã€è®¿é—®æ—¶é—´ã€è®¿é—®åœ°ç‚¹)
4. æœç´¢å¹¶é€‰æ‹©è¢«è®¿äºº
5. æäº¤é¢„çº¦ç”³è¯·

#### é˜¶æ®µ2: å¤šçº§å®¡æ‰¹(å‘˜å·¥/å®‰ä¿ç«¯)
1. **ä¸€çº§å®¡æ‰¹(è¢«è®¿äºº)**:
   - æ¥æ”¶å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥
   - æŸ¥çœ‹è®¿å®¢ä¿¡æ¯å’Œæ¥è®¿ç›®çš„
   - å®¡æ‰¹æ“ä½œ: é€šè¿‡/æ‹’ç»(å¡«å†™å®¡æ‰¹æ„è§)
   
2. **äºŒçº§å®¡æ‰¹(å®‰ä¿/ä¸»ç®¡)**:
   - è¢«è®¿äººé€šè¿‡å,è§¦å‘å®‰ä¿å®¡æ‰¹
   - å®‰ä¿æŸ¥çœ‹è®¿å®¢ä¿¡æ¯ã€é»‘åå•æ ¡éªŒ
   - æœ€ç»ˆå®¡æ‰¹: é€šè¿‡/æ‹’ç»

#### é˜¶æ®µ3: é—¨ç¦æƒé™ä¸‹å‘(ç³»ç»Ÿè‡ªåŠ¨)
1. å®¡æ‰¹é€šè¿‡å,ç³»ç»Ÿè‡ªåŠ¨è§¦å‘æƒé™ä¸‹å‘
2. è°ƒç”¨é—¨ç¦ç³»ç»ŸAPI,åˆ›å»ºè®¿å®¢æƒé™
3. è®¾ç½®æƒé™æœ‰æ•ˆæœŸ(è®¿é—®æ—¥æœŸå½“å¤©)
4. æŒ‡å®šå¯è®¿é—®çš„é—¨ç¦ç‚¹(å¦‚ä¸»å…¥å£ã€ç”µæ¢¯)
5. å¼‚æ­¥ä¸‹å‘,å¤±è´¥é‡è¯•3æ¬¡
6. ä¸‹å‘ç»“æœæ¨é€å¾®ä¿¡é€šçŸ¥ç»™è®¿å®¢

#### é˜¶æ®µ4: è®¿å®¢ç­¾åˆ°(è®¿å®¢ç«¯)
1. è®¿å®¢åˆ°è¾¾å›­åŒº,æ‰«æäºŒç»´ç /äººè„¸è¯†åˆ«
2. ç³»ç»ŸéªŒè¯é¢„çº¦è®°å½•å’Œé—¨ç¦æƒé™
3. è®°å½•ç­¾åˆ°æ—¶é—´å’Œç­¾åˆ°æ–¹å¼
4. é€šçŸ¥è¢«è®¿äºº"è®¿å®¢å·²åˆ°è¾¾"
5. é—¨ç¦å¼€é—¨æ”¾è¡Œ

#### é˜¶æ®µ5: è®¿é—®æœŸé—´(ç›‘æ§)
1. é—¨ç¦ç³»ç»Ÿè®°å½•è®¿å®¢åˆ·å¡æ—¥å¿—
2. ç³»ç»Ÿç›‘æ§è®¿å®¢é€¾æœŸ(è¶…è¿‡é¢„çº¦æ—¶é—´)
3. é€¾æœŸè‡ªåŠ¨å‘Šè­¦å®‰ä¿

#### é˜¶æ®µ6: è®¿å®¢ç­¾é€€(è®¿å®¢ç«¯)
1. è®¿å®¢ç¦»åœºå‰ç­¾é€€
2. è®°å½•ç­¾é€€æ—¶é—´
3. è®¡ç®—å®é™…è®¿é—®æ—¶é•¿
4. é—¨ç¦æƒé™è‡ªåŠ¨å›æ”¶

#### é˜¶æ®µ7: æ•°æ®åˆ†æ(ç®¡ç†åå°)
1. è®¿å®¢é‡ç»Ÿè®¡(æ—¥/å‘¨/æœˆè¶‹åŠ¿)
2. éƒ¨é—¨è®¿å®¢æ’è¡Œ
3. å¼‚å¸¸é¢„è­¦(é»‘åå•ã€é€¾æœŸè®¿å®¢)

### 2.2 ç”¨æˆ·è§’è‰²æ¸…å•

| è§’è‰² | æ ¸å¿ƒèŒè´£ | ä¸»è¦åœºæ™¯ | æƒé™çº§åˆ« |
|------|----------|----------|----------|
| **è®¿å®¢** | æäº¤é¢„çº¦ç”³è¯·ã€ç­¾åˆ°ç­¾é€€ | é¢„çº¦æäº¤ã€æ‰«ç ç­¾åˆ° | ğŸŸ¢ åªèƒ½æ“ä½œè‡ªå·±çš„é¢„çº¦ |
| **è¢«è®¿äºº(å‘˜å·¥)** | å®¡æ‰¹è®¿å®¢é¢„çº¦ã€æ¥å¾…è®¿å®¢ | é¢„çº¦å®¡æ‰¹(ä¸€çº§)ã€æ¥æ”¶ç­¾åˆ°é€šçŸ¥ | ğŸŸ¡ åªèƒ½å®¡æ‰¹è‡ªå·±çš„è®¿å®¢ |
| **å®‰ä¿äººå‘˜** | ç»ˆå®¡é¢„çº¦ã€ç°åœºæ ¸éªŒã€å¼‚å¸¸å¤„ç† | é¢„çº¦å®¡æ‰¹(äºŒçº§)ã€é»‘åå•ç®¡ç†ã€ç°åœºæ ¸éªŒ | ğŸŸ  å¯æŸ¥è¯¢æ‰€æœ‰è®¿å®¢è®°å½• |
| **ç®¡ç†å‘˜** | ç³»ç»Ÿé…ç½®ã€æ•°æ®ç»Ÿè®¡ã€æƒé™ç®¡ç† | ç³»ç»Ÿé…ç½®ã€æŠ¥è¡¨æŸ¥è¯¢ã€ç”¨æˆ·ç®¡ç† | ğŸ”´ å…¨éƒ¨æƒé™ |
| **é—¨ç¦ç³»ç»Ÿ** | æƒé™ç®¡ç†ã€å¼€é—¨æ§åˆ¶ã€æ—¥å¿—è®°å½• | æ¥æ”¶æƒé™ä¸‹å‘ã€éªŒè¯è®¿å®¢èº«ä»½ | âš™ï¸ å¤–éƒ¨ç³»ç»Ÿé›†æˆ |

### 2.3 å¤–éƒ¨ç³»ç»Ÿé›†æˆæ¸…å•

| ç³»ç»Ÿåç§° | é›†æˆæ–¹å¼ | æ•°æ®æµå‘ | é›†æˆéš¾åº¦ | å…³é”®æ¥å£ |
|----------|----------|----------|----------|----------|
| **æµ·åº·å¨è§†é—¨ç¦** | HTTP API | åŒå‘(æƒé™ä¸‹å‘+æ—¥å¿—å›è¯») | â­â­â­â­ é«˜ | `POST /access/grant`<br>`GET /access/logs` |
| **å¾®ä¿¡å…¬ä¼—å·** | å¾®ä¿¡å¼€æ”¾å¹³å°API | å•å‘(ç³»ç»Ÿâ†’å¾®ä¿¡) | â­â­â­ ä¸­ | OAuth2.0è®¤è¯<br>æ¨¡æ¿æ¶ˆæ¯æ¨é€ |
| **çŸ­ä¿¡æœåŠ¡** | é˜¿é‡Œäº‘çŸ­ä¿¡API | å•å‘(ç³»ç»Ÿâ†’çŸ­ä¿¡å¹³å°) | â­â­ ä½ | `POST /sms/send` |
| **å¯¹è±¡å­˜å‚¨OSS** | é˜¿é‡Œäº‘OSS SDK | ä¸Šä¼ (è®¿å®¢ç…§ç‰‡) | â­ ç®€å• | `PUT /upload` |

---

## ä¸‰ã€ä¸‰å¤§æŠ€æœ¯éš¾ç‚¹æ·±åº¦åˆ†æ

### ğŸ” éš¾ç‚¹1: é—¨ç¦é›†æˆ

#### 3.1.1 æŠ€æœ¯æŒ‘æˆ˜åˆ†æ

| æŒ‘æˆ˜ç»´åº¦ | å…·ä½“é—®é¢˜ | æŠ€æœ¯å½±å“ | é£é™©ç­‰çº§ |
|----------|----------|----------|----------|
| **åè®®å¤šæ ·æ€§** | ä¸åŒå“ç‰ŒAPIå·®å¼‚å¤§(HTTP/SDK/MQTT/ç§æœ‰åè®®) | éœ€è¦é€‚é…å™¨æ¨¡å¼è®¾è®¡,ä»£ç å¤æ‚åº¦â†‘30% | ğŸ”´ é«˜ |
| **å®æ—¶æ€§è¦æ±‚** | å®¡æ‰¹é€šè¿‡å5åˆ†é’Ÿå†…å¿…é¡»ä¸‹å‘æƒé™ | éœ€è¦å¼‚æ­¥é˜Ÿåˆ—+é‡è¯•æœºåˆ¶,æ¶æ„å¤æ‚åº¦â†‘ | ğŸŸ¡ ä¸­ |
| **åŒå‘åŒæ­¥** | æ—¢è¦ä¸‹å‘æƒé™,ä¹Ÿè¦å›è¯»åˆ·å¡æ—¥å¿— | æ¥å£è°ƒç”¨æ¬¡æ•°å¤š,ç½‘ç»œç¨³å®šæ€§è¦æ±‚é«˜ | ğŸŸ¡ ä¸­ |
| **å¼‚å¸¸å¤„ç†** | é—¨ç¦ç¦»çº¿ã€ç½‘ç»œæ•…éšœã€APIè¶…æ—¶ | éœ€è¦é™çº§æ–¹æ¡ˆ(æ‰‹åŠ¨åŒæ­¥),ç”¨æˆ·ä½“éªŒâ†“ | ğŸ”´ é«˜ |
| **æƒé™ç²’åº¦** | æ§åˆ¶å…·ä½“é—¨ç‚¹(ä¸»å…¥å£/ç”µæ¢¯/æ¥¼å±‚é—¨)ã€æ—¶é—´æ®µ | æ•°æ®æ¨¡å‹å¤æ‚,éœ€æ”¯æŒJSONåŠ¨æ€é…ç½® | ğŸŸ¡ ä¸­ |
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡ä¸‹å‘/æ’¤é”€æƒé™(å¦‚å›¢é˜Ÿè®¿é—®) | éœ€è¦é˜Ÿåˆ—å‰Šå³°,é¿å…APIé™æµ | ğŸŸ¡ ä¸­ |

#### 3.1.2 æµ·åº·å¨è§†é—¨ç¦APIè°ƒç ”

```java
// æµ·åº·å¨è§†é—¨ç¦APIç¤ºä¾‹(åŸºäºHTTP)
// æ¥å£åœ°å€: http://{device-ip}/ISAPI/AccessControl/

// 1. æ·»åŠ è®¿å®¢æƒé™
POST /ISAPI/AccessControl/CardInfo/SetUp
Content-Type: application/xml

<CardInfo>
    <employeeNo>VISITOR_001</employeeNo>
    <cardNo>6224001234567890</cardNo>
    <name>å¼ ä¸‰</name>
    <userType>visitor</userType>
    <Valid>
        <enable>true</enable>
        <beginTime>2025-01-15T08:00:00</beginTime>
        <endTime>2025-01-15T18:00:00</endTime>
    </Valid>
    <doorRight>
        <doorNo>1</doorNo><!-- ä¸»å…¥å£ -->
        <doorNo>3</doorNo><!-- ç”µæ¢¯ -->
    </doorRight>
</CardInfo>

// 2. åˆ é™¤è®¿å®¢æƒé™
POST /ISAPI/AccessControl/CardInfo/Delete
<CardInfoDelCond>
    <EmployeeNoList>
        <employeeNo>VISITOR_001</employeeNo>
    </EmployeeNoList>
</CardInfoDelCond>

// 3. æŸ¥è¯¢åˆ·å¡è®°å½•
POST /ISAPI/AccessControl/AcsEvent?format=json
{
    "searchID": "001",
    "searchResultPosition": 0,
    "maxResults": 100,
    "AcsEventCond": {
        "searchTimeType": "startTime",
        "beginTime": "2025-01-15T00:00:00",
        "endTime": "2025-01-15T23:59:59",
        "employeeNo": "VISITOR_001"
    }
}
```

#### 3.1.3 MVPå®æ–½æ–¹æ¡ˆ

**æŠ€æœ¯é€‰å‹: é€‚é…å™¨æ¨¡å¼ + å¼‚æ­¥é˜Ÿåˆ—**

```java
// æ¥å£æŠ½è±¡å±‚(æ”¯æŒæœªæ¥å¤šå“ç‰Œæ‰©å±•)
public interface AccessControlAdapter {
    /**
     * ä¸‹å‘è®¿å®¢æƒé™
     * @param visitorId è®¿å®¢ID
     * @param doorIds é—¨ç¦ç‚¹åˆ—è¡¨
     * @param validFrom æƒé™ç”Ÿæ•ˆæ—¶é—´
     * @param validTo æƒé™å¤±æ•ˆæ—¶é—´
     * @return æƒé™ID
     */
    String grantAccess(String visitorId, List<String> doorIds, 
                       LocalDateTime validFrom, LocalDateTime validTo);
    
    /**
     * æ’¤é”€è®¿å®¢æƒé™
     */
    void revokeAccess(String permissionId);
    
    /**
     * æŸ¥è¯¢è®¿å®¢åˆ·å¡æ—¥å¿—
     */
    List<AccessLog> getAccessLogs(String visitorId, LocalDate date);
    
    /**
     * å¥åº·æ£€æŸ¥(åˆ¤æ–­é—¨ç¦ç³»ç»Ÿæ˜¯å¦åœ¨çº¿)
     */
    boolean healthCheck();
}

// æµ·åº·å¨è§†å®ç°
@Component
public class HikVisionAdapter implements AccessControlAdapter {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Value("${hikvision.api.baseUrl}")
    private String baseUrl;
    
    @Override
    public String grantAccess(String visitorId, List<String> doorIds,
                              LocalDateTime validFrom, LocalDateTime validTo) {
        try {
            // æ„é€ XMLè¯·æ±‚ä½“
            String xmlBody = buildCardInfoXml(visitorId, doorIds, validFrom, validTo);
            
            // è°ƒç”¨æµ·åº·API
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_XML);
            headers.setBasicAuth(username, password); // HTTP Basicè®¤è¯
            
            HttpEntity<String> request = new HttpEntity<>(xmlBody, headers);
            ResponseEntity<String> response = restTemplate.postForEntity(
                baseUrl + "/ISAPI/AccessControl/CardInfo/SetUp",
                request,
                String.class
            );
            
            // è§£æå“åº”,è¿”å›æƒé™ID
            return parsePermissionId(response.getBody());
            
        } catch (RestClientException e) {
            // å¼‚å¸¸å¤„ç†: è®°å½•æ—¥å¿—,æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
            log.error("é—¨ç¦æƒé™ä¸‹å‘å¤±è´¥: visitorId={}, error={}", visitorId, e.getMessage());
            throw new AccessControlException("é—¨ç¦ç³»ç»Ÿè¿æ¥å¤±è´¥", e);
        }
    }
    
    @Override
    public boolean healthCheck() {
        try {
            restTemplate.getForEntity(baseUrl + "/ISAPI/System/deviceInfo", String.class);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}

// å¼‚æ­¥é˜Ÿåˆ—å¤„ç†æœåŠ¡
@Service
public class AccessPermissionService {
    
    @Autowired
    private AccessControlAdapter accessControlAdapter;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * å¼‚æ­¥ä¸‹å‘é—¨ç¦æƒé™(å®¡æ‰¹é€šè¿‡åè°ƒç”¨)
     */
    @Async
    public void syncToAccessControlAsync(Long appointmentId) {
        // å‘é€åˆ°RabbitMQé˜Ÿåˆ—,å¼‚æ­¥å¤„ç†
        rabbitTemplate.convertAndSend("access.permission.queue", appointmentId);
    }
    
    /**
     * æ¶ˆè´¹é˜Ÿåˆ—,å®é™…æ‰§è¡Œä¸‹å‘
     */
    @RabbitListener(queues = "access.permission.queue")
    @Retryable(value = AccessControlException.class, maxAttempts = 3, backoff = @Backoff(delay = 5000))
    public void processAccessPermission(Long appointmentId) {
        // 1. æŸ¥è¯¢é¢„çº¦ä¿¡æ¯
        Appointment appointment = appointmentRepository.findById(appointmentId).orElseThrow();
        
        // 2. è°ƒç”¨é—¨ç¦é€‚é…å™¨ä¸‹å‘æƒé™
        String permissionId = accessControlAdapter.grantAccess(
            appointment.getVisitorId(),
            appointment.getDoorIds(),
            appointment.getVisitDate().atTime(8, 0),
            appointment.getVisitDate().atTime(20, 0)
        );
        
        // 3. æ›´æ–°æƒé™è®°å½•è¡¨
        AccessPermission permission = new AccessPermission();
        permission.setAppointmentId(appointmentId);
        permission.setPermissionId(permissionId);
        permission.setSyncStatus("SYNCED");
        permission.setSyncTime(LocalDateTime.now());
        accessPermissionRepository.save(permission);
        
        // 4. å‘é€å¾®ä¿¡é€šçŸ¥ç»™è®¿å®¢
        messageService.sendAsync(appointment.getVisitorPhone(), 
            "PERMISSION_GRANTED", 
            Map.of("date", appointment.getVisitDate().toString()));
    }
    
    /**
     * é‡è¯•å¤±è´¥åçš„å…œåº•å¤„ç†
     */
    @Recover
    public void recoverFromAccessControlFailure(AccessControlException e, Long appointmentId) {
        // è®°å½•å¤±è´¥æ—¥å¿—
        AccessPermission permission = new AccessPermission();
        permission.setAppointmentId(appointmentId);
        permission.setSyncStatus("FAILED");
        permission.setErrorMessage(e.getMessage());
        accessPermissionRepository.save(permission);
        
        // å‘é€å‘Šè­¦ç»™å®‰ä¿(éœ€è¦æ‰‹åŠ¨å¤„ç†)
        messageService.sendAsync("13800138000", "PERMISSION_SYNC_FAILED", 
            Map.of("appointmentId", appointmentId.toString()));
    }
}
```

#### 3.1.4 é™çº§æ–¹æ¡ˆ(æ‰‹åŠ¨åŒæ­¥)

```java
// ç®¡ç†åå°æä¾›æ‰‹åŠ¨åŒæ­¥æŒ‰é’®
@RestController
@RequestMapping("/api/admin/access-permission")
public class AccessPermissionController {
    
    /**
     * æ‰‹åŠ¨åŒæ­¥é—¨ç¦æƒé™(å…œåº•æ–¹æ¡ˆ)
     */
    @PostMapping("/{appointmentId}/manual-sync")
    @PreAuthorize("hasRole('SECURITY')")
    public Result manualSync(@PathVariable Long appointmentId) {
        try {
            accessPermissionService.syncToAccessControlAsync(appointmentId);
            return Result.success("åŒæ­¥ä»»åŠ¡å·²æäº¤,è¯·ç¨åæŸ¥çœ‹ç»“æœ");
        } catch (Exception e) {
            return Result.fail("åŒæ­¥å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æŸ¥çœ‹åŒæ­¥çŠ¶æ€
     */
    @GetMapping("/{appointmentId}/sync-status")
    public Result getSyncStatus(@PathVariable Long appointmentId) {
        AccessPermission permission = accessPermissionRepository.findByAppointmentId(appointmentId);
        return Result.success(permission);
    }
}
```

#### 3.1.5 é£é™©åº”å¯¹æªæ–½

| é£é™©åœºæ™¯ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | éªŒè¯æ–¹å¼ |
|----------|------|----------|----------|
| é—¨ç¦ç³»ç»Ÿç¦»çº¿ | 30% | âœ… é™çº§æ–¹æ¡ˆ:å®‰ä¿æ‰‹åŠ¨å½•å…¥<br>âœ… å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡(5åˆ†é’Ÿ/æ¬¡)<br>âœ… ç¦»çº¿å‘Šè­¦æ¨é€ | é¢„ç ”é˜¶æ®µæ‹”ç½‘çº¿æµ‹è¯• |
| APIæ–‡æ¡£ä¸å…¨ | 60% | âœ… é¢„ç ”é˜¶æ®µå¿…é¡»è·å–çœŸå®è®¾å¤‡<br>âœ… ä¸æµ·åº·ç­¾è®¢æŠ€æœ¯æ”¯æŒåè®®<br>âœ… æŠ“åŒ…åˆ†æAPIç»†èŠ‚ | çœŸæœºæµ‹è¯•3å¤© |
| å¹¶å‘ä¸‹å‘é™æµ | 40% | âœ… RabbitMQé˜Ÿåˆ—å‰Šå³°<br>âœ… é™æµ:æ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚<br>âœ… æ‰¹é‡ä¸‹å‘åˆå¹¶ | å‹æµ‹100å¹¶å‘ |
| æƒé™ä¸‹å‘å»¶è¿Ÿ | 20% | âœ… å¼‚æ­¥å¤„ç†,ä¸é˜»å¡å®¡æ‰¹æµç¨‹<br>âœ… SLA:5åˆ†é’Ÿå†…ä¸‹å‘<br>âœ… è¶…æ—¶å‘Šè­¦ | ç›‘æ§P95å»¶è¿Ÿ |

---

### ğŸ“± éš¾ç‚¹2: æ¶ˆæ¯æ¨é€

#### 3.2.1 æ¶ˆæ¯æ¨é€åœºæ™¯æ¢³ç†

```mermaid
graph TB
    A[è®¿å®¢æäº¤ç”³è¯·] -->|å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯| B[é€šçŸ¥è¢«è®¿äºº]
    B -->|å®¡æ‰¹é€šè¿‡| C[é€šçŸ¥ä¸»ç®¡/å®‰ä¿]
    C -->|æœ€ç»ˆå®¡æ‰¹ç»“æœ| D[é€šçŸ¥è®¿å®¢]
    D -->|å®¡æ‰¹é€šè¿‡| E[æå‰1å°æ—¶æé†’è®¿å®¢]
    F[è®¿å®¢ç­¾åˆ°æˆåŠŸ] -->|å¾®ä¿¡æ¶ˆæ¯| G[é€šçŸ¥è¢«è®¿äºº]
    H[è®¿å®¢é€¾æœŸæœªç¦»åœº] -->|å‘Šè­¦çŸ­ä¿¡| I[é€šçŸ¥å®‰ä¿]
    J[é—¨ç¦æƒé™ä¸‹å‘å¤±è´¥] -->|å‘Šè­¦| K[é€šçŸ¥ç®¡ç†å‘˜]
```

**å…³é”®æ¶ˆæ¯åœºæ™¯æ¸…å•**:

| æ¶ˆæ¯ç±»å‹ | è§¦å‘æ¡ä»¶ | æ¥æ”¶äºº | æ¨é€æ¸ é“ | ä¼˜å…ˆçº§ | æ˜¯å¦å¿…è¾¾ |
|----------|----------|--------|----------|--------|----------|
| é¢„çº¦å®¡æ‰¹é€šçŸ¥ | è®¿å®¢æäº¤ç”³è¯· | è¢«è®¿äºº | å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ | ğŸ”´ é«˜ | âœ… æ˜¯ |
| äºŒçº§å®¡æ‰¹é€šçŸ¥ | è¢«è®¿äººé€šè¿‡ | å®‰ä¿/ä¸»ç®¡ | å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ | ğŸ”´ é«˜ | âœ… æ˜¯ |
| å®¡æ‰¹ç»“æœé€šçŸ¥ | æœ€ç»ˆå®¡æ‰¹å®Œæˆ | è®¿å®¢ | å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ + çŸ­ä¿¡(å…œåº•) | ğŸ”´ é«˜ | âœ… æ˜¯ |
| ç­¾åˆ°æé†’ | è®¿é—®æ—¥æœŸå‰1å°æ—¶ | è®¿å®¢ | å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ | ğŸŸ¡ ä¸­ | âŒ å¦ |
| ç­¾åˆ°æˆåŠŸé€šçŸ¥ | è®¿å®¢æ‰«ç ç­¾åˆ° | è¢«è®¿äºº | å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ | ğŸŸ¡ ä¸­ | âŒ å¦ |
| é€¾æœŸå‘Šè­¦ | è¶…è¿‡è®¿é—®æ—¶é—´30åˆ†é’Ÿ | å®‰ä¿ | çŸ­ä¿¡ | ğŸ”´ é«˜ | âœ… æ˜¯ |
| æƒé™ä¸‹å‘å¤±è´¥ | é—¨ç¦åŒæ­¥å¤±è´¥3æ¬¡ | å®‰ä¿ + ç®¡ç†å‘˜ | çŸ­ä¿¡ + ç«™å†…æ¶ˆæ¯ | ğŸ”´ é«˜ | âœ… æ˜¯ |

#### 3.2.2 æŠ€æœ¯æŒ‘æˆ˜åˆ†æ

| æŒ‘æˆ˜ç»´åº¦ | å…·ä½“é—®é¢˜ | æŠ€æœ¯å½±å“ | MVPæ–¹æ¡ˆ |
|----------|----------|----------|---------|
| **å¤šæ¸ é“é€‚é…** | å¾®ä¿¡/çŸ­ä¿¡/ä¼ä¸šå¾®ä¿¡/é‚®ä»¶APIä¸åŒ | éœ€è¦ç­–ç•¥æ¨¡å¼è®¾è®¡ | åªåšå¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ + çŸ­ä¿¡å…œåº• |
| **åˆ°è¾¾ç‡ä¿è¯** | å¾®ä¿¡æ¶ˆæ¯å¯èƒ½å› ç”¨æˆ·å±è”½å¤±è´¥ | éœ€è¦å¤±è´¥é‡è¯• + å¤šæ¸ é“é™çº§ | å¤±è´¥è®°å½•æ—¥å¿—,ä¸é‡è¯•(é¿å…éªšæ‰°) |
| **æ¶ˆæ¯é™æµ** | å¾®ä¿¡å…¬ä¼—å·é™æµ:1ä¸‡æ¬¡/å¤©,100æ¬¡/åˆ†é’Ÿ | éœ€è¦é™æµå™¨ + æ¶ˆæ¯åˆå¹¶ | å•ç”¨æˆ·æ¯å¤©æœ€å¤šæ”¶10æ¡ |
| **æ¨¡æ¿ç®¡ç†** | ä¸åŒåœºæ™¯æ¶ˆæ¯å†…å®¹ä¸åŒ | éœ€è¦é…ç½®è¡¨åŠ¨æ€ç®¡ç† | é…ç½®è¡¨ + Freemarkeræ¨¡æ¿ |
| **å¼‚æ­¥åŒ–** | å‘é€æ¶ˆæ¯è€—æ—¶(200ms+),ä¸èƒ½é˜»å¡ä¸»æµç¨‹ | éœ€è¦æ¶ˆæ¯é˜Ÿåˆ— | Spring @Asyncå¼‚æ­¥å‘é€ |

#### 3.2.3 å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯æ¥å…¥

```java
// å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ•°æ®ç»“æ„
{
  "touser": "OPENID",
  "template_id": "ngqIpbwh8bUfcSsECmogfXcV14J0tQlEpBO27izEYtY",
  "url": "http://weixin.qq.com/download",
  "data": {
    "first": {
      "value": "æ‚¨æœ‰ä¸€æ¡æ–°çš„è®¿å®¢é¢„çº¦å¾…å®¡æ‰¹",
      "color": "#173177"
    },
    "keyword1": {
      "value": "å¼ ä¸‰",
      "color": "#173177"
    },
    "keyword2": {
      "value": "2025-01-15 14:00-17:00",
      "color": "#173177"
    },
    "remark": {
      "value": "è¯·åŠæ—¶å¤„ç†,ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…",
      "color": "#173177"
    }
  }
}
```

**MVPå®æ–½æ–¹æ¡ˆ: ç­–ç•¥æ¨¡å¼ + å¼‚æ­¥é˜Ÿåˆ—**

```java
// æ¶ˆæ¯æ¸ é“æ¥å£
public interface MessageChannel {
    /**
     * å‘é€æ¶ˆæ¯
     * @param userId ç”¨æˆ·ID(æ‰‹æœºå·æˆ–OpenID)
     * @param templateCode æ¨¡æ¿ç¼–ç 
     * @param params æ¨¡æ¿å‚æ•°
     * @return æ˜¯å¦å‘é€æˆåŠŸ
     */
    boolean send(String userId, String templateCode, Map<String, String> params);
    
    /**
     * æ¸ é“åç§°
     */
    String getChannelName();
}

// å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¸ é“å®ç°
@Component
public class WeChatTemplateMessageChannel implements MessageChannel {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Value("${wechat.appid}")
    private String appId;
    
    @Value("${wechat.secret}")
    private String appSecret;
    
    private String accessToken; // ç¼“å­˜access_token(2å°æ—¶æœ‰æ•ˆæœŸ)
    
    @Override
    public boolean send(String userId, String templateCode, Map<String, String> params) {
        try {
            // 1. è·å–access_token(å…ˆä»Redisç¼“å­˜å–,æ²¡æœ‰åˆ™è°ƒAPI)
            String token = getAccessToken();
            
            // 2. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·OpenID
            String openId = userRepository.findOpenIdByPhone(userId);
            if (openId == null) {
                log.warn("ç”¨æˆ·æœªå…³æ³¨å…¬ä¼—å·,æ— æ³•å‘é€å¾®ä¿¡æ¶ˆæ¯: userId={}", userId);
                return false;
            }
            
            // 3. æ ¹æ®templateCodeè·å–æ¨¡æ¿IDå’Œå‚æ•°æ˜ å°„
            MessageTemplate template = messageTemplateRepository.findByCode(templateCode);
            
            // 4. æ„é€ è¯·æ±‚ä½“
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("touser", openId);
            requestBody.put("template_id", template.getWechatTemplateId());
            requestBody.put("url", template.getJumpUrl());
            requestBody.put("data", buildTemplateData(params, template));
            
            // 5. è°ƒç”¨å¾®ä¿¡API
            String url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" + token;
            ResponseEntity<Map> response = restTemplate.postForEntity(url, requestBody, Map.class);
            
            // 6. è§£æå“åº”
            Map<String, Object> result = response.getBody();
            int errcode = (int) result.get("errcode");
            
            if (errcode == 0) {
                log.info("å¾®ä¿¡æ¶ˆæ¯å‘é€æˆåŠŸ: userId={}, templateCode={}", userId, templateCode);
                return true;
            } else {
                log.error("å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥: userId={}, errcode={}, errmsg={}", 
                    userId, errcode, result.get("errmsg"));
                return false;
            }
            
        } catch (Exception e) {
            log.error("å¾®ä¿¡æ¶ˆæ¯å‘é€å¼‚å¸¸: userId={}, error={}", userId, e.getMessage());
            return false;
        }
    }
    
    @Override
    public String getChannelName() {
        return "WECHAT_TEMPLATE";
    }
    
    /**
     * è·å–access_token(ç¼“å­˜2å°æ—¶)
     */
    @Cacheable(value = "wechat:access_token", unless = "#result == null")
    private String getAccessToken() {
        String url = String.format(
            "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s",
            appId, appSecret
        );
        Map<String, Object> response = restTemplate.getForObject(url, Map.class);
        return (String) response.get("access_token");
    }
}

// çŸ­ä¿¡æ¸ é“å®ç°(å…œåº•)
@Component
public class AliyunSmsChannel implements MessageChannel {
    
    @Override
    public boolean send(String userId, String templateCode, Map<String, String> params) {
        // è°ƒç”¨é˜¿é‡Œäº‘çŸ­ä¿¡API
        // å®ç°ç•¥...
        return true;
    }
    
    @Override
    public String getChannelName() {
        return "ALIYUN_SMS";
    }
}

// æ¶ˆæ¯æœåŠ¡(ç»Ÿä¸€å…¥å£)
@Service
public class MessageService {
    
    @Autowired
    private List<MessageChannel> messageChannels; // Springè‡ªåŠ¨æ³¨å…¥æ‰€æœ‰å®ç°ç±»
    
    @Autowired
    private MessageLogRepository messageLogRepository;
    
    /**
     * å‘é€æ¶ˆæ¯(å¼‚æ­¥)
     */
    @Async
    public void sendAsync(String userId, String templateCode, Map<String, String> params) {
        // 1. æŸ¥è¯¢æ¨¡æ¿é…ç½®
        MessageTemplate template = messageTemplateRepository.findByCode(templateCode);
        
        // 2. æ ¹æ®æ¨¡æ¿ä¼˜å…ˆçº§é€‰æ‹©æ¸ é“
        String channelName = template.getPrimaryChannel(); // WECHAT_TEMPLATE / ALIYUN_SMS
        MessageChannel channel = getChannel(channelName);
        
        // 3. å‘é€æ¶ˆæ¯
        boolean success = channel.send(userId, templateCode, params);
        
        // 4. è®°å½•æ—¥å¿—
        MessageLog log = new MessageLog();
        log.setUserId(userId);
        log.setTemplateCode(templateCode);
        log.setChannel(channelName);
        log.setStatus(success ? "SUCCESS" : "FAILED");
        log.setParams(JSON.toJSONString(params));
        log.setSendTime(LocalDateTime.now());
        messageLogRepository.save(log);
        
        // 5. å¦‚æœå¤±è´¥ä¸”æ˜¯é«˜ä¼˜å…ˆçº§æ¶ˆæ¯,é™çº§åˆ°çŸ­ä¿¡
        if (!success && template.getPriority().equals("HIGH")) {
            MessageChannel smsChannel = getChannel("ALIYUN_SMS");
            smsChannel.send(userId, templateCode, params);
        }
    }
    
    /**
     * æ‰¹é‡å‘é€(é¿å…å¾ªç¯è°ƒç”¨sendAsync)
     */
    public void sendBatch(List<String> userIds, String templateCode, Map<String, String> params) {
        userIds.forEach(userId -> sendAsync(userId, templateCode, params));
    }
    
    private MessageChannel getChannel(String channelName) {
        return messageChannels.stream()
            .filter(c -> c.getChannelName().equals(channelName))
            .findFirst()
            .orElseThrow(() -> new IllegalArgumentException("ä¸æ”¯æŒçš„æ¶ˆæ¯æ¸ é“: " + channelName));
    }
}
```

#### 3.2.4 æ¶ˆæ¯æ¨¡æ¿é…ç½®è¡¨è®¾è®¡

```sql
-- æ¶ˆæ¯æ¨¡æ¿é…ç½®è¡¨
CREATE TABLE message_template (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) UNIQUE NOT NULL COMMENT 'æ¨¡æ¿ç¼–ç ,å¦‚APPROVAL_NOTIFY',
    name VARCHAR(100) NOT NULL COMMENT 'æ¨¡æ¿åç§°',
    primary_channel VARCHAR(20) NOT NULL COMMENT 'ä¸»æ¨é€æ¸ é“:WECHAT_TEMPLATE/ALIYUN_SMS',
    fallback_channel VARCHAR(20) COMMENT 'é™çº§æ¸ é“',
    priority VARCHAR(10) NOT NULL COMMENT 'ä¼˜å…ˆçº§:HIGH/MEDIUM/LOW',
    wechat_template_id VARCHAR(100) COMMENT 'å¾®ä¿¡æ¨¡æ¿ID',
    sms_template_code VARCHAR(50) COMMENT 'çŸ­ä¿¡æ¨¡æ¿CODE',
    jump_url VARCHAR(200) COMMENT 'ç‚¹å‡»è·³è½¬URL',
    param_mapping JSON COMMENT 'å‚æ•°æ˜ å°„é…ç½®',
    enabled BOOLEAN DEFAULT TRUE,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO message_template VALUES
(1, 'APPROVAL_NOTIFY', 'é¢„çº¦å®¡æ‰¹é€šçŸ¥', 'WECHAT_TEMPLATE', 'ALIYUN_SMS', 'HIGH', 
 'ngqIpbwh8bUfcSsECmogfXcV14J0tQlEpBO27izEYtY', 'SMS_123456', 
 'https://mp.weixin.qq.com/approval/detail', 
 '{"first":"æ‚¨æœ‰ä¸€æ¡æ–°çš„è®¿å®¢é¢„çº¦å¾…å®¡æ‰¹","keyword1":"{{visitorName}}","keyword2":"{{visitTime}}"}',
 TRUE, NOW());
```

#### 3.2.5 æ¶ˆæ¯é™æµç­–ç•¥

```java
// ä½¿ç”¨Guava RateLimiteré™æµ
@Component
public class MessageRateLimiter {
    
    // å…¨å±€é™æµ: 100æ¡/åˆ†é’Ÿ(å¾®ä¿¡å…¬ä¼—å·é™åˆ¶)
    private final RateLimiter globalLimiter = RateLimiter.create(100.0 / 60.0);
    
    // ç”¨æˆ·çº§é™æµ: æ¯ç”¨æˆ·10æ¡/å¤©
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    /**
     * æ£€æŸ¥æ˜¯å¦å…è®¸å‘é€
     */
    public boolean allowSend(String userId) {
        // 1. å…¨å±€é™æµæ£€æŸ¥
        if (!globalLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
            log.warn("å…¨å±€é™æµè§¦å‘,æ¶ˆæ¯å‘é€è¢«æ‹’ç»");
            return false;
        }
        
        // 2. ç”¨æˆ·çº§é™æµæ£€æŸ¥
        String key = "message:limit:" + userId + ":" + LocalDate.now();
        Integer count = redisTemplate.opsForValue().get(key);
        
        if (count != null && count >= 10) {
            log.warn("ç”¨æˆ·{}ä»Šæ—¥æ¶ˆæ¯å·²è¾¾ä¸Šé™", userId);
            return false;
        }
        
        // 3. è®¡æ•°å™¨+1
        redisTemplate.opsForValue().increment(key);
        redisTemplate.expire(key, 1, TimeUnit.DAYS);
        
        return true;
    }
}
```

---

### ğŸ”’ éš¾ç‚¹3: æ•°æ®å®‰å…¨

#### 3.3.1 æ•æ„Ÿæ•°æ®è¯†åˆ«

**æ•°æ®åˆ†çº§æ¸…å•**:

| æ•°æ®ç±»å‹ | æ•æ„Ÿçº§åˆ« | æ•°æ®ç¤ºä¾‹ | æ³•å¾‹ä¾æ® | å­˜å‚¨æ–¹å¼ | è®¿é—®æ§åˆ¶ |
|----------|----------|----------|----------|----------|----------|
| **èº«ä»½è¯å·** | ğŸ”´ é«˜æ•æ„Ÿ | 110101199001011234 | ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ | AES-256åŠ å¯†å­˜å‚¨ | ä»…ç®¡ç†å‘˜/å®‰ä¿å¯æŸ¥çœ‹å®Œæ•´å· |
| **æ‰‹æœºå·** | ğŸŸ¡ ä¸­æ•æ„Ÿ | 138****1234 | ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ | æ˜æ–‡(éœ€å‘çŸ­ä¿¡) | è„±æ•å±•ç¤º(ä¸­é—´4ä½*) |
| **è®¿å®¢ç…§ç‰‡** | ğŸŸ¡ ä¸­æ•æ„Ÿ | å¤´åƒ/è¯ä»¶ç…§ | ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ | OSSå¯¹è±¡å­˜å‚¨,URLç­¾å | ä»…æœ¬äºº/è¢«è®¿äºº/å®‰ä¿å¯è®¿é—® |
| **è®¿é—®è®°å½•** | ğŸŸ¢ ä½æ•æ„Ÿ | è®¿é—®æ—¶é—´/åœ°ç‚¹/ç›®çš„ | - | æ˜æ–‡ | æŒ‰è§’è‰²åˆ†çº§æŸ¥çœ‹ |
| **é—¨ç¦æ—¥å¿—** | ğŸŸ¢ ä½æ•æ„Ÿ | åˆ·å¡æ—¶é—´/é—¨ç‚¹ | - | æ˜æ–‡ | å®‰ä¿/ç®¡ç†å‘˜å¯è§ |
| **å®¡æ‰¹æ„è§** | ğŸŸ¢ ä½æ•æ„Ÿ | æ–‡æœ¬å†…å®¹ | - | æ˜æ–‡ | å…³è”äººå‘˜å¯è§ |

#### 3.3.2 å®‰å…¨å¨èƒåˆ†æ(STRIDEæ¨¡å‹)

```mermaid
graph TB
    A[æ•°æ®å®‰å…¨å¨èƒ] --> B[Spoofing èº«ä»½ä¼ªé€ ]
    A --> C[Tampering æ•°æ®ç¯¡æ”¹]
    A --> D[Repudiation å¦è®¤]
    A --> E[Information Disclosure ä¿¡æ¯æ³„éœ²]
    A --> F[Denial of Service æ‹’ç»æœåŠ¡]
    A --> G[Elevation of Privilege æƒé™æå‡]
    
    B --> B1[è®¿å®¢ä¼ªé€ è¢«è®¿äººèº«ä»½å®¡æ‰¹]
    C --> C1[æ¶æ„ä¿®æ”¹è®¿é—®è®°å½•]
    D --> D1[å¦è®¤æ›¾å®¡æ‰¹è¿‡æŸè®¿å®¢]
    E --> E1[æ•°æ®åº“æ‹–åº“æ³„éœ²èº«ä»½è¯]
    E --> E2[APIæœªé‰´æƒæ³„éœ²è®¿å®¢åˆ—è¡¨]
    F --> F1[æ¶æ„å¤§é‡é¢„çº¦DoSæ”»å‡»]
    G --> G1[æ™®é€šå‘˜å·¥è¶ŠæƒæŸ¥çœ‹å…¨éƒ¨æ•°æ®]
```

**å¨èƒåº”å¯¹çŸ©é˜µ**:

| å¨èƒç±»å‹ | å…·ä½“åœºæ™¯ | é£é™©ç­‰çº§ | åº”å¯¹æªæ–½ | éªŒè¯æ–¹å¼ |
|----------|----------|----------|----------|----------|
| **èº«ä»½ä¼ªé€ ** | è®¿å®¢ä¼ªé€ è¢«è®¿äººèº«ä»½å®¡æ‰¹ | ğŸ”´ é«˜ | âœ… å¾®ä¿¡OAuth2.0å®åè®¤è¯<br>âœ… æ‰‹æœºå·éªŒè¯ç äºŒæ¬¡éªŒè¯<br>âœ… æ“ä½œæ—¥å¿—è®°å½•IP | æ¸—é€æµ‹è¯• |
| **æ•°æ®ç¯¡æ”¹** | æ¶æ„ä¿®æ”¹è®¿é—®è®°å½• | ğŸ”´ é«˜ | âœ… æ•°æ®åº“å­—æ®µçº§æƒé™æ§åˆ¶<br>âœ… å®¡è®¡æ—¥å¿—ä¸å¯ç¯¡æ”¹(å†™å…¥ElasticSearch)<br>âœ… å…³é”®æ“ä½œMFA | å°è¯•SQLæ³¨å…¥ |
| **ä¿¡æ¯æ³„éœ²** | æ•°æ®åº“æ‹–åº“ | ğŸ”´ é«˜ | âœ… èº«ä»½è¯å·AES-256åŠ å¯†<br>âœ… æ•°æ®åº“è®¿é—®IPç™½åå•<br>âœ… å®šæœŸå®‰å…¨æ‰«æ | å®‰å…¨å®¡è®¡ |
| **APIæœªé‰´æƒ** | æœªç™»å½•è®¿é—®è®¿å®¢åˆ—è¡¨ | ğŸ”´ é«˜ | âœ… æ‰€æœ‰APIå¼ºåˆ¶JWTé‰´æƒ<br>âœ… RBACæƒé™æ§åˆ¶<br>âœ… APIé™æµ(100æ¬¡/åˆ†é’Ÿ) | æ¥å£æµ‹è¯• |
| **æƒé™æå‡** | å‘˜å·¥è¶ŠæƒæŸ¥çœ‹ä»–äººè®¿å®¢ | ğŸŸ¡ ä¸­ | âœ… æ•°æ®èŒƒå›´æ§åˆ¶(åªèƒ½çœ‹è‡ªå·±çš„)<br>âœ… æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯ | åŠŸèƒ½æµ‹è¯• |
| **DoSæ”»å‡»** | æ¶æ„å¤§é‡é¢„çº¦ | ğŸŸ¡ ä¸­ | âœ… IPé™æµ:åŒIPæ¯å¤©æœ€å¤š10æ¬¡é¢„çº¦<br>âœ… éªŒè¯ç é˜²åˆ·<br>âœ… CDNé˜²æŠ¤ | å‹åŠ›æµ‹è¯• |

#### 3.3.3 MVPå®‰å…¨æ–¹æ¡ˆ

**1. ä¼ è¾“åŠ å¯†: HTTPSå…¨ç«™**

```nginx
# Nginxé…ç½®
server {
    listen 443 ssl http2;
    server_name visitor.example.com;
    
    # Let's Encryptå…è´¹è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/visitor.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/visitor.example.com/privkey.pem;
    
    # å¼ºåˆ¶HTTPS
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # HSTS(å¼ºåˆ¶æµè§ˆå™¨ä½¿ç”¨HTTPS)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
```

**2. æ¥å£é‰´æƒ: Spring Security + JWT**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .csrf().disable() // REST APIä¸éœ€è¦CSRF
            .cors().and() // å…è®¸è·¨åŸŸ
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS) // æ— çŠ¶æ€
            .and()
            .authorizeRequests()
                // å…¬å¼€æ¥å£
                .antMatchers("/api/public/**").permitAll()
                .antMatchers("/api/auth/login").permitAll()
                // è§’è‰²æƒé™
                .antMatchers("/api/admin/**").hasRole("ADMIN")
                .antMatchers("/api/security/**").hasAnyRole("SECURITY", "ADMIN")
                // å…¶ä»–æ¥å£éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            .and()
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
    }
}

// JWTè¿‡æ»¤å™¨
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtTokenProvider jwtTokenProvider;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        // 1. ä»Headerè·å–Token
        String token = request.getHeader("Authorization");
        if (token != null && token.startsWith("Bearer ")) {
            token = token.substring(7);
        }
        
        // 2. éªŒè¯Token
        if (token != null && jwtTokenProvider.validateToken(token)) {
            // 3. è§£æç”¨æˆ·ä¿¡æ¯
            String userId = jwtTokenProvider.getUserIdFromToken(token);
            List<String> roles = jwtTokenProvider.getRolesFromToken(token);
            
            // 4. è®¾ç½®åˆ°SecurityContext
            UsernamePasswordAuthenticationToken authentication = 
                new UsernamePasswordAuthenticationToken(userId, null, 
                    roles.stream().map(SimpleGrantedAuthority::new).collect(Collectors.toList()));
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        
        filterChain.doFilter(request, response);
    }
}
```

**3. å­—æ®µåŠ å¯†: AES-256**

```java
@Component
public class FieldEncryptor {
    
    @Value("${security.encryption.key}")
    private String encryptionKey; // 32ä½å¯†é’¥,å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒ
    
    /**
     * åŠ å¯†èº«ä»½è¯å·
     */
    public String encrypt(String plainText) {
        try {
            SecretKeySpec secretKey = new SecretKeySpec(encryptionKey.getBytes(), "AES");
            Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
            cipher.init(Cipher.ENCRYPT_MODE, secretKey);
            byte[] encrypted = cipher.doFinal(plainText.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    /**
     * è§£å¯†èº«ä»½è¯å·
     */
    public String decrypt(String cipherText) {
        try {
            SecretKeySpec secretKey = new SecretKeySpec(encryptionKey.getBytes(), "AES");
            Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
            cipher.init(Cipher.DECRYPT_MODE, secretKey);
            byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(cipherText));
            return new String(decrypted);
        } catch (Exception e) {
            throw new RuntimeException("è§£å¯†å¤±è´¥", e);
        }
    }
}

// åœ¨Entityä¸­è‡ªåŠ¨åŠ è§£å¯†
@Entity
@Table(name = "appointment")
public class Appointment {
    
    @Column(name = "visitor_id_card", length = 200)
    @Convert(converter = IdCardEncryptConverter.class) // JPAè‡ªåŠ¨åŠ è§£å¯†
    private String visitorIdCard;
}

@Converter
public class IdCardEncryptConverter implements AttributeConverter<String, String> {
    
    @Autowired
    private FieldEncryptor encryptor;
    
    @Override
    public String convertToDatabaseColumn(String attribute) {
        return encryptor.encrypt(attribute); // å­˜å‚¨å‰åŠ å¯†
    }
    
    @Override
    public String convertToEntityAttribute(String dbData) {
        return encryptor.decrypt(dbData); // æŸ¥è¯¢åè§£å¯†
    }
}
```

**4. æ“ä½œæ—¥å¿—: AOPåˆ‡é¢**

```java
// è‡ªå®šä¹‰æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AuditLog {
    String operation(); // æ“ä½œç±»å‹:CREATE/UPDATE/DELETE
    String targetType(); // ç›®æ ‡ç±»å‹:APPOINTMENT/USER
}

// AOPåˆ‡é¢
@Aspect
@Component
public class AuditLogAspect {
    
    @Autowired
    private AuditLogRepository auditLogRepository;
    
    @Around("@annotation(auditLog)")
    public Object logOperation(ProceedingJoinPoint pjp, AuditLog auditLog) throws Throwable {
        // 1. æ‰§è¡Œå‰è®°å½•
        String userId = SecurityContextHolder.getContext().getAuthentication().getName();
        String methodName = pjp.getSignature().getName();
        Object[] args = pjp.getArgs();
        
        // 2. æ‰§è¡Œæ–¹æ³•
        Object result = pjp.proceed();
        
        // 3. æ‰§è¡Œåè®°å½•æ—¥å¿—
        AuditLogEntity log = new AuditLogEntity();
        log.setUserId(userId);
        log.setOperation(auditLog.operation());
        log.setTargetType(auditLog.targetType());
        log.setTargetId(extractTargetId(result)); // ä»è¿”å›å€¼æå–ID
        log.setMethodName(methodName);
        log.setParams(JSON.toJSONString(args));
        log.setIpAddress(getClientIp());
        log.setCreateTime(LocalDateTime.now());
        
        auditLogRepository.save(log);
        
        return result;
    }
    
    private String getClientIp() {
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        return request.getRemoteAddr();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class AppointmentService {
    
    @AuditLog(operation = "CREATE", targetType = "APPOINTMENT")
    public Appointment createAppointment(AppointmentDTO dto) {
        // åˆ›å»ºé¢„çº¦
        Appointment appointment = new Appointment();
        // ...
        return appointmentRepository.save(appointment);
    }
    
    @AuditLog(operation = "UPDATE", targetType = "APPOINTMENT")
    public Appointment approveAppointment(Long appointmentId, String comment) {
        // å®¡æ‰¹é¢„çº¦
        // ...
        return appointmentRepository.save(appointment);
    }
}
```

**5. RBACæƒé™çŸ©é˜µ**

```java
// è§’è‰²æšä¸¾
public enum Role {
    VISITOR,    // è®¿å®¢
    EMPLOYEE,   // å‘˜å·¥
    SECURITY,   // å®‰ä¿
    ADMIN       // ç®¡ç†å‘˜
}

// æƒé™é…ç½®
@Configuration
public class PermissionConfig {
    
    public static final Map<String, List<Role>> PERMISSION_MATRIX = Map.of(
        // é¢„çº¦ç®¡ç†
        "appointment:create", List.of(Role.VISITOR, Role.EMPLOYEE, Role.SECURITY, Role.ADMIN),
        "appointment:approve", List.of(Role.EMPLOYEE, Role.SECURITY, Role.ADMIN),
        "appointment:view:own", List.of(Role.VISITOR, Role.EMPLOYEE),
        "appointment:view:all", List.of(Role.SECURITY, Role.ADMIN),
        "appointment:delete", List.of(Role.ADMIN),
        
        // ç”¨æˆ·ç®¡ç†
        "user:create", List.of(Role.ADMIN),
        "user:update", List.of(Role.ADMIN),
        "user:view:all", List.of(Role.ADMIN),
        
        // ç³»ç»Ÿé…ç½®
        "system:config", List.of(Role.ADMIN),
        
        // æ•æ„Ÿæ•°æ®
        "data:idcard:view", List.of(Role.SECURITY, Role.ADMIN)
    );
}

// æƒé™æ£€æŸ¥
@Service
public class PermissionService {
    
    public boolean hasPermission(String userId, String permission) {
        User user = userRepository.findById(userId).orElseThrow();
        List<Role> allowedRoles = PermissionConfig.PERMISSION_MATRIX.get(permission);
        return allowedRoles != null && allowedRoles.contains(user.getRole());
    }
}
```

#### 3.3.4 æ•°æ®è„±æ•å±•ç¤º

```java
// æ‰‹æœºå·è„±æ•å·¥å…·
public class SensitiveDataMask {
    
    /**
     * æ‰‹æœºå·è„±æ•: 138****1234
     */
    public static String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * èº«ä»½è¯å·è„±æ•: 110101********1234
     */
    public static String maskIdCard(String idCard) {
        if (idCard == null || idCard.length() != 18) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }
    
    /**
     * å§“åè„±æ•: å¼ **(ä»…å¯¹éå…³è”äººè„±æ•)
     */
    public static String maskName(String name) {
        if (name == null || name.length() == 0) {
            return name;
        }
        return name.charAt(0) + "**";
    }
}

// åœ¨DTOä¸­è‡ªåŠ¨è„±æ•
@Data
public class AppointmentVO {
    private Long id;
    
    @JsonSerialize(using = PhoneMaskSerializer.class) // è‡ªåŠ¨è„±æ•
    private String visitorPhone;
    
    @JsonSerialize(using = IdCardMaskSerializer.class)
    private String visitorIdCard;
    
    private String visitorName;
}

// è‡ªå®šä¹‰åºåˆ—åŒ–å™¨
public class PhoneMaskSerializer extends JsonSerializer<String> {
    @Override
    public void serialize(String value, JsonGenerator gen, SerializerProvider serializers) 
        throws IOException {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æƒé™
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        boolean canViewFull = auth.getAuthorities().stream()
            .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
        
        if (canViewFull) {
            gen.writeString(value); // ç®¡ç†å‘˜çœ‹å®Œæ•´å·ç 
        } else {
            gen.writeString(SensitiveDataMask.maskPhone(value)); // å…¶ä»–äººçœ‹è„±æ•
        }
    }
}
```

#### 3.3.5 åˆè§„è¦æ±‚å¯¹ç…§è¡¨

| æ³•å¾‹æ³•è§„ | å…³é”®æ¡æ¬¾ | ç³»ç»Ÿå®ç° | åˆè§„çŠ¶æ€ |
|----------|----------|----------|----------|
| **ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹** | ç¬¬51æ¡:æ•æ„Ÿä¸ªäººä¿¡æ¯åŠ å¯†å­˜å‚¨ | âœ… èº«ä»½è¯å·AES-256åŠ å¯† | âœ… åˆè§„ |
| **ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹** | ç¬¬13æ¡:æ˜ç¤ºæ”¶é›†ä½¿ç”¨è§„åˆ™ | âœ… é¢„çº¦é¡µé¢æ˜¾ç¤ºéšç§æ”¿ç­– | âœ… åˆè§„ |
| **ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹** | ç¬¬21æ¡:é‡‡å–æ•°æ®åˆ†ç±»ã€å¤‡ä»½ç­‰æªæ–½ | âœ… æ¯æ—¥è‡ªåŠ¨å¤‡ä»½,ä¿ç•™7å¤© | âœ… åˆè§„ |
| **ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹** | ç¬¬40æ¡:ä¸å¾—æ³„éœ²ã€ç¯¡æ”¹ã€æ¯æŸ | âœ… æ“ä½œæ—¥å¿—å®¡è®¡,æƒé™æ§åˆ¶ | âœ… åˆè§„ |
| **ç­‰ä¿2.0ä¸‰çº§** | èº«ä»½é‰´åˆ« | âš ï¸ MVPæš‚ç”¨JWT,ç­‰ä¿è®¤è¯éœ€MFA | âš ï¸ éƒ¨åˆ†åˆè§„ |
| **ç­‰ä¿2.0ä¸‰çº§** | å®¡è®¡æ—¥å¿— | âš ï¸ MVPæ—¥å¿—å­˜MySQL,éœ€ç‹¬ç«‹å®¡è®¡ç³»ç»Ÿ | âš ï¸ éƒ¨åˆ†åˆè§„ |

**MVPé˜¶æ®µå®‰å…¨å¦¥åç‚¹**:
- âœ… **å¿…é¡»å®ç°**: HTTPSã€JWTã€RBACã€æ“ä½œæ—¥å¿—ã€å­—æ®µåŠ å¯†
- âš ï¸ **å¯å»¶å**: ç­‰ä¿ä¸‰çº§è®¤è¯ã€ç‹¬ç«‹å®¡è®¡ç³»ç»Ÿã€MFAåŒå› å­è®¤è¯ã€æ•°æ®åº“å®¡è®¡
- ğŸ“‹ **é£é™©**: MVPé˜¶æ®µå¯èƒ½æ— æ³•é€šè¿‡ç­‰ä¿ä¸‰çº§è®¤è¯,éœ€è¯„ä¼°å›­åŒºæ˜¯å¦å¼ºåˆ¶è¦æ±‚

---

