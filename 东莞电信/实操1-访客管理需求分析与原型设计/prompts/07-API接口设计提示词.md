# 步骤7：RESTful API接口设计提示词（通用版）

> **📌 使用场景**：基于用户故事，设计符合RESTful规范的API接口

---

## 🎭 R - 角色定义

你是一位资深后端架构师，拥有10年RESTful API设计经验，擅长：

- RESTful API设计最佳实践（资源命名、HTTP方法、状态码规范）
- API版本管理和向后兼容性设计
- 安全认证方案设计（JWT、OAuth2.0、API Key）
- 接口性能优化（分页、缓存、限流策略）
- API文档规范编写（符合OpenAPI 3.0标准）

---

## 📋 T - 任务描述

基于用户故事（User Story），设计符合RESTful规范的API接口文档。

### 输入材料

#### 材料1：用户故事

```markdown
{请粘贴用户故事内容，至少包含以下部分}

必须包含：
- Story描述（Who-What-Why格式）
- 验收标准（Given-When-Then格式）
- 技术实现建议（可选，如有）
- 数据模型说明（可选，如有）
```

#### 材料2：数据模型（可选）

```markdown
{如果有SRS文档或数据库设计，请粘贴相关实体定义}

示例：
- 实体名称
- 字段列表（字段名、类型、约束）
- 关联关系
```

### 任务上下文

- **设计目标**：为前端/移动端提供清晰、一致、易用的API接口
- **技术栈**：RESTful + JSON，遵循HTTP标准
- **安全要求**：所有接口需考虑认证、授权、数据验证
- **性能要求**：支持分页、缓存、限流等优化策略

---

## 🎯 G - 目标与意图

### 核心目标

设计符合RESTful规范、安全可靠、易于集成的API接口，支持前后端分离开发和第三方系统集成。

### 具体目标

1. **规范性**：遵循RESTful最佳实践，使用标准HTTP方法和状态码，资源命名清晰一致
2. **完整性**：覆盖Story中所有业务场景（正常流程、异常处理、边界条件）
3. **安全性**：明确认证授权方案，定义数据验证规则，防止常见安全漏洞（SQL注入、XSS等）
4. **可用性**：提供清晰的请求/响应示例，错误码定义明确，支持前端快速集成

### 业务价值

- **为前端开发**：提供清晰的接口契约，减少联调沟通成本，支持并行开发
- **为后端开发**：明确接口规范，统一开发标准，提高代码质量
- **为测试团队**：提供接口测试依据，支持自动化测试用例编写
- **为第三方集成**：标准化接口设计，降低集成难度，提升系统开放性

### 成功标准

- ✅ API设计符合RESTful规范，资源命名遵循行业惯例（如复数名词、小写字母、连字符分隔）
- ✅ 覆盖Story中所有验收标准，每个Scenario对应至少1个API接口
- ✅ 所有接口定义包含完整的请求/响应示例和错误码说明
- ✅ 安全认证方案明确，数据验证规则完整（字段类型、长度、格式、必填性）

---

## 📤 O - 输出要求

### 1. 输出结构

```markdown
# {功能模块名称} API接口设计文档

## 1. 接口清单

| 接口ID | 接口名称 | HTTP方法 | 路径 | 说明 | 认证 |
|-------|---------|---------|------|------|------|
| {模块}-API-001 | {接口名称} | GET/POST/PUT/DELETE | /api/v1/{resource} | {简要说明} | 是/否 |

---

## 2. 接口详细设计

### {模块}-API-001: {接口名称}

#### 基本信息

- **接口ID**: {模块}-API-001
- **接口名称**: {功能描述}
- **HTTP方法**: GET/POST/PUT/DELETE/PATCH
- **请求路径**: /api/v1/{resource}/{id}
- **认证方式**: JWT Token / API Key / 无需认证
- **权限要求**: {角色权限，如：访客/被访人/安保/管理员}
- **限流策略**: {如：100次/分钟/IP}

#### 业务说明

{描述接口的业务场景和用途，关联到Story的哪个验收标准}

#### 请求参数

**路径参数（Path Parameters）**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|------|------|------|
| {param} | string/integer | 是/否 | {说明} | {示例值} |

**查询参数（Query Parameters）**

| 参数名 | 类型 | 必填 | 说明 | 默认值 | 示例 |
|-------|------|------|------|--------|------|
| {param} | string | 否 | {说明} | {默认值} | {示例值} |

**请求头（Headers）**

| Header名称 | 必填 | 说明 | 示例 |
|-----------|------|------|------|
| Authorization | 是/否 | JWT Token | Bearer eyJhbGc... |
| Content-Type | 是 | 请求体格式 | application/json |

**请求体（Request Body）**

```json
{
  "field1": "string",
  "field2": 123,
  "field3": {
    "nestedField": "value"
  },
  "field4": ["item1", "item2"]
}
```

**字段说明**

| 字段名 | 类型 | 必填 | 说明 | 验证规则 |
|-------|------|------|------|---------|
| field1 | string | 是 | {说明} | 长度2-50，正则: /^[\u4e00-\u9fa5a-zA-Z]+$/ |
| field2 | integer | 是 | {说明} | 范围: 1-100 |

#### 响应结果

**成功响应（200 OK）**

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": "123",
    "field1": "value1",
    "field2": "value2",
    "createdAt": "2025-01-27T10:30:00Z",
    "updatedAt": "2025-01-27T10:30:00Z"
  },
  "timestamp": "2025-01-27T10:30:00Z"
}
```

**分页响应（如适用）**

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "items": [
      { "id": "1", "name": "Item 1" },
      { "id": "2", "name": "Item 2" }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 100,
      "totalPages": 10
    }
  },
  "timestamp": "2025-01-27T10:30:00Z"
}
```

**错误响应**

| HTTP状态码 | 错误码 | 错误消息 | 说明 | 示例响应 |
|-----------|--------|---------|------|---------|
| 400 | INVALID_PARAMETER | 参数验证失败 | 请求参数格式错误 | {"code": 400, "message": "手机号格式错误", "errors": [{"field": "mobile", "message": "必须为11位数字"}]} |
| 401 | UNAUTHORIZED | 未授权 | Token缺失或无效 | {"code": 401, "message": "请先登录"} |
| 403 | FORBIDDEN | 禁止访问 | 无权限访问该资源 | {"code": 403, "message": "无权访问该预约记录"} |
| 404 | NOT_FOUND | 资源不存在 | 请求的资源未找到 | {"code": 404, "message": "预约记录不存在"} |
| 409 | CONFLICT | 资源冲突 | 重复提交等冲突 | {"code": 409, "message": "今日已提交预约"} |
| 429 | TOO_MANY_REQUESTS | 请求过于频繁 | 超过限流阈值 | {"code": 429, "message": "请求过于频繁，请1分钟后重试"} |
| 500 | INTERNAL_ERROR | 服务器内部错误 | 系统异常 | {"code": 500, "message": "系统繁忙，请稍后重试"} |

#### 业务规则

- {规则1}：{具体说明}
- {规则2}：{具体说明}
- {规则3}：{具体说明}

#### 调用示例

**cURL示例**

```bash
curl -X POST 'https://api.example.com/api/v1/{resource}' \
  -H 'Authorization: Bearer eyJhbGc...' \
  -H 'Content-Type: application/json' \
  -d '{
    "field1": "value1",
    "field2": 123
  }'
```

**JavaScript (Axios) 示例**

```javascript
const response = await axios.post('/api/v1/{resource}', {
  field1: 'value1',
  field2: 123
}, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

#### 性能要求

- 响应时间：P95 ≤ {X}秒
- 并发支持：{N} TPS
- 缓存策略：{如：Redis缓存，TTL 5分钟}

#### 安全要求

- 认证：{JWT Token，过期时间2小时}
- 授权：{基于角色的访问控制（RBAC）}
- 数据验证：{服务端强制验证所有必填字段}
- 防护措施：{SQL注入防护、XSS防护、CSRF Token}

#### 测试要点

- ✅ 正常流程：{测试场景1}
- ✅ 异常流程：{测试场景2}
- ✅ 边界条件：{测试场景3}
- ✅ 权限验证：{测试场景4}

---

{继续编写其他接口，结构相同}

---

## 3. 通用规范

### 3.1 API版本管理

- 版本号：在URL路径中体现，如 `/api/v1/`
- 版本策略：向后兼容至少2个版本
- 废弃通知：提前3个月通知，响应头添加 `X-API-Deprecated: true`

### 3.2 认证授权

**JWT Token认证**

- Token格式：`Bearer {JWT_TOKEN}`
- Token有效期：2小时
- Refresh Token：7天
- Token内容：`{"userId": "123", "role": "visitor", "exp": 1234567890}`

**权限角色定义**

| 角色 | 权限范围 | 说明 |
|-----|---------|------|
| visitor | 访客 | 仅可访问自己的预约记录 |
| host | 被访人 | 可审批自己的访客预约 |
| security | 安保 | 可查看所有预约、审批、管理门禁 |
| admin | 管理员 | 拥有所有权限 |

### 3.3 数据格式规范

**请求体格式**

- Content-Type: `application/json`
- 字符编码: UTF-8
- 日期时间格式: ISO 8601 (`2025-01-27T10:30:00Z`)

**响应体统一结构**

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": "2025-01-27T10:30:00Z",
  "traceId": "abc123xyz"
}
```

### 3.4 分页规范

**请求参数**

- `page`: 页码，从1开始
- `pageSize`: 每页条数，默认10，最大100

**响应结构**

```json
{
  "items": [],
  "pagination": {
    "page": 1,
    "pageSize": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

### 3.5 错误码规范

**错误码格式**: `{模块}_{错误类型}_{序号}`

示例：
- `APPOINTMENT_INVALID_PARAMETER_001`: 访客预约参数验证失败
- `APPOINTMENT_BUSINESS_001`: 访客预约业务规则冲突

### 3.6 限流策略

- IP限流：100次/分钟
- 用户限流：50次/分钟
- 全局限流：1000 TPS
- 超限响应：HTTP 429 + Retry-After header

---

## 4. 数据字典

### 4.1 枚举值定义

**预约状态（AppointmentStatus）**

| 值 | 说明 |
|----|-----|
| PENDING | 待审批 |
| APPROVED | 已通过 |
| REJECTED | 已拒绝 |
| CHECKED_IN | 已签到 |
| COMPLETED | 已完成 |
| CANCELLED | 已取消 |

**来访目的（VisitPurpose）**

| 值 | 说明 |
|----|-----|
| BUSINESS | 商务洽谈 |
| INTERVIEW | 面试 |
| VISIT | 参观 |
| DELIVERY | 送货 |
| OTHER | 其他 |

### 4.2 公共数据模型

**分页请求参数**

```json
{
  "page": 1,
  "pageSize": 10,
  "sortBy": "createdAt",
  "sortOrder": "desc"
}
```

**错误详情**

```json
{
  "code": 400,
  "message": "参数验证失败",
  "errors": [
    {
      "field": "mobile",
      "message": "手机号格式错误",
      "value": "12345"
    }
  ],
  "timestamp": "2025-01-27T10:30:00Z",
  "traceId": "abc123xyz"
}
```

---

## 5. 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| v1.0 | 2025-01-27 | 初始版本 | {作者} |

```

### 2. 质量要求

#### RESTful规范符合性（强制）

- **资源命名**：使用复数名词（如 `/appointments` 而非 `/appointment`）
- **HTTP方法**：
  - GET：查询资源（幂等）
  - POST：创建资源（非幂等）
  - PUT：全量更新资源（幂等）
  - PATCH：部分更新资源（幂等）
  - DELETE：删除资源（幂等）
- **状态码**：使用标准HTTP状态码（200/201/400/401/403/404/500等）
- **URL结构**：`/api/{version}/{resource}/{id}/{sub-resource}`

#### 安全要求（强制）

- **认证**：所有接口必须明确是否需要认证
- **授权**：说明需要的角色权限
- **数据验证**：定义所有字段的验证规则（类型、长度、格式、范围）
- **敏感数据**：明确哪些字段需要加密传输或脱敏展示

#### 完整性要求（强制）

- 每个接口必须包含：
  - 请求参数完整定义（包含验证规则）
  - 成功响应示例（至少1个）
  - 错误响应列表（覆盖常见错误场景）
  - 调用示例（cURL + 一种编程语言）

#### 可追溯性（建议）

- 每个接口关联到Story的验收标准
- 格式：`（关联Story US-001 > Scenario 1）`

### 3. 格式规范

- **文档格式**: Markdown
- **表格**: 用于参数定义、错误码列表
- **代码块**: 用于JSON示例、调用示例
- **emoji**: 适度使用（✅测试点 ⚠️注意事项 🔒安全要求）

### 4. 特别说明

#### 接口拆分原则

如果一个Story涉及多个操作，按以下原则拆分接口：

1. **按CRUD拆分**：创建/查询/更新/删除对应不同接口
2. **按资源拆分**：不同资源使用不同接口（如 `/appointments` 和 `/approvals`）
3. **按操作拆分**：特殊操作独立接口（如 `/appointments/{id}/cancel`）

#### 数据验证规则编写

验证规则必须明确且可执行：

- ❌ 不好：`手机号必须合法`
- ✅ 好：`11位数字，正则: /^1[3-9]\d{9}$/`

#### 错误消息编写

错误消息必须对用户友好且actionable：

- ❌ 不好：`参数错误`
- ✅ 好：`手机号格式错误，必须为11位数字`

#### 分页接口设计

分页接口必须提供完整的分页信息：

- 请求参数：`page`（页码）、`pageSize`（每页条数）
- 响应信息：`total`（总条数）、`totalPages`（总页数）

### 5. 输出格式

直接输出完整的API接口设计文档，按照上述结构组织。

**注意**：不要有任何前言、说明或总结性文字，直接输出接口文档。

---

## ✨ 使用说明

### 如何使用此提示词

1. **准备输入材料**
   - 用户故事（从步骤3的输出获取）
   - 数据模型（从SRS文档或数据库设计获取，可选）

2. **复制提示词**
   - 从"你是一位资深后端架构师"开始

3. **粘贴到AI工具**
   - 将提示词和用户故事一起提交

4. **生成API接口设计**
   - AI将生成符合RESTful规范的接口文档

5. **人工审核和优化**（重要！）
   - **验证RESTful规范**: 资源命名、HTTP方法、状态码是否正确？
   - **检查完整性**: 请求参数、响应示例、错误码是否完整？
   - **评估安全性**: 认证授权、数据验证、防护措施是否足够？
   - **验证可用性**: 前端是否可以根据文档快速集成？
   - **调整业务规则**: 与业务团队确认业务逻辑是否准确

6. **团队评审**
   - 召集前端、后端、测试评审
   - 确认接口设计符合开发需求
   - 识别潜在问题和改进点

7. **保存文档**
   - 保存到`outputs/07-{模块名称}-API接口设计.md`

### 预期生成时间

- AI生成：5-8分钟
- 人工审核优化：30-45分钟
- 团队评审：45-60分钟

### 下一步操作

API接口设计完成后：
1. 进入步骤8：生成OpenAPI/Swagger文档
2. 进入步骤9：生成接口测试用例

---

**📌 重要提醒**：
- API设计是前后端协作的契约，必须经过双方确认
- 接口一旦发布，修改成本高，设计阶段务必充分讨论
- 安全性和性能要求必须在设计阶段明确
- 错误码设计要统一规范，便于前端统一处理
- 所有接口必须有完整的测试用例覆盖
