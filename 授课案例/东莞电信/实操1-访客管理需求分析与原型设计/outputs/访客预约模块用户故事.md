# 访客预约模块用户故事

## 第1部分：用户故事全景图（Story Map）

```
Epic: 数据标注园区访客管理系统 - 访客预约模块

┌─────────────────────────────────────────────────────────────────────────┐
│ 用户活动流（User Activities）                                            │
├───────────┬───────────┬───────────┬───────────┬───────────┬─────────────┤
│ 访客预约  │ 审批处理  │ 权限下发  │ 访客签到  │ 访客管理  │ 数据统计    │
└───────────┴───────────┴───────────┴───────────┴───────────┴─────────────┘

Release 1 (MVP - 4周)：
- US-001: 访客在线提交预约申请
- US-002: 访客查询预约记录
- US-003: 访客取消待审批预约
- US-004: 被访人审批访客预约（一级审批）
- US-005: 安保审批访客预约（二级审批）

Release 2 (增强 - 3周)：
- US-006: 团队访客批量预约
- US-007: 审批流程自定义配置
- US-008: 访客黑白名单管理

Release 3 (优化 - 2周)：
- US-009: 访客预约数据统计分析
- US-010: 访客预约提醒推送
```

---

## 第2部分:用户故事详细列表

### US-001: 访客在线提交预约申请

**Story ID**: US-001
**Story名称**: 

**Epic**: 访客预约模块
**优先级**: P0
**故事点**: 5点（4-5天完成）
**迭代**: Sprint 1

**用户故事描述**（Who-What-Why格式）:

```
作为 访客
我想要 通过微信公众号在线提交来访预约申请
以便于 无需电话联系，提前完成来访登记，节省现场办理时间
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功提交预约申请
  Given 访客已关注微信公众号并完成授权登录
  And 访客填写了所有必填字段（姓名、手机号、身份证号、照片、来访目的、访问日期、访问时段、被访人）
  When 访客点击"提交预约"按钮
  Then 系统生成预约单号（格式YY202511270001）
  And 预约状态为"待审批"
  And 访客收到"预约提交成功"的确认消息
  And 被访人收到"有新的访客预约待审批"的微信模板消息

Scenario 2: 必填字段缺失时提交失败
  Given 访客已登录微信公众号
  When 访客未填写必填字段（如姓名为空）
  And 访客点击"提交预约"按钮
  Then 系统显示错误提示"请填写访客姓名"
  And 预约未提交

Scenario 3: 身份证号格式验证失败
  Given 访客已登录微信公众号
  When 访客填写身份证号为"123456"（格式错误）
  And 访客点击"提交预约"按钮
  Then 系统显示错误提示"身份证号格式不正确，请填写18位身份证号"
  And 预约未提交

Scenario 4: 照片上传成功
  Given 访客已登录微信公众号
  When 访客上传JPG格式照片（文件大小1.5MB）
  Then 照片上传成功
  And 显示照片预览
  And 上传时间≤3秒

Scenario 5: 同一天重复提交预约被拦截
  Given 访客已在当天提交过1次预约
  When 访客再次尝试提交新预约（同一天）
  Then 系统显示错误提示"您今天已提交过预约，同一天只能提交1次"
  And 预约未提交
```

**技术实现建议**:

- 前端：微信公众号H5页面（Vue.js），微信JSSDK调用相册/拍照
- 后端：Spring Boot RESTful API，身份证号格式验证（正则表达式），实名核验（调用公安部接口或第三方服务）
- 数据库：预约表（appointments），字段包括预约单号、访客信息、被访人ID、预约状态、创建时间等
- 集成：微信模板消息推送（通知被访人）

**依赖**:

- 微信公众号开发者账号配置完成
- 被访人（员工）数据已导入系统

**风险**:

- 实名核验第三方接口可用性（成功率需≥95%）
- 照片上传受网络环境影响，需要重试机制

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 身份证验证准确率100%，实名核验成功率≥95%
- ✅ 产品经理演示通过

---

### US-002: 访客查询预约记录

**Story ID**: US-002
**Story名称**: 访客查询预约记录
**Epic**: 访客预约模块
**优先级**: P0
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 1

**用户故事描述**（Who-What-Why格式）:

```
作为 访客
我想要 查询我的历史预约记录和当前预约状态
以便于 了解预约审批进度、签到状态，以及查看历史来访记录
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功查询预约记录列表
  Given 访客已登录微信公众号
  And 访客历史上有5条预约记录
  When 访客进入"我的预约"页面
  Then 显示预约记录列表（默认显示最近7天）
  And 每条记录显示：预约单号、被访人、访问时间、审批状态
  And 列表支持分页（每页10条）
  And 页面加载时间≤2秒

Scenario 2: 按状态筛选预约记录
  Given 访客进入"我的预约"页面
  When 访客选择状态筛选器"已通过"
  Then 只显示状态为"已通过"的预约记录
  And 筛选结果准确率100%

Scenario 3: 查看预约详情
  Given 访客在预约列表中
  When 访客点击某条预约记录
  Then 显示预约详情页，包括：
    - 预约基本信息（访客姓名、手机、来访目的等）
    - 审批进度（被访人审批状态、安保审批状态）
    - 审批意见（如有拒绝原因）
    - 门禁权限状态（已下发/未下发）
    - 签到状态（未签到/已签到）

Scenario 4: 预约详情页操作按钮显示
  Given 访客查看某条预约详情
  When 预约状态为"待审批"
  Then 显示"取消预约"按钮（可点击）
  And "查看二维码"按钮不可用（灰色）

Scenario 5: 查看已通过预约的签到二维码
  Given 访客查看某条预约详情
  When 预约状态为"已通过"且未过期
  Then 显示"查看二维码"按钮（可点击）
  When 访客点击"查看二维码"
  Then 显示签到二维码（用于现场扫码签到）
```

**技术实现建议**:

- 前端：微信公众号H5页面，列表组件（支持分页和筛选），二维码展示（qrcodejs）
- 后端：Spring Boot RESTful API（GET /api/appointments），分页查询（PageHelper）
- 数据库：查询appointments表，关联users表获取被访人姓名
- 集成：无

**依赖**:

- US-001（必须先能提交预约）

**风险**:

- 无

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 查询列表加载时间≤2秒
- ✅ 产品经理演示通过

---

### US-003: 访客取消待审批预约

**Story ID**: US-003
**Story名称**: 访客取消待审批预约
**Epic**: 访客预约模块
**优先级**: P1
**故事点**: 2点（1-2天完成）
**迭代**: Sprint 1

**用户故事描述**（Who-What-Why格式）:

```
作为 访客
我想要 取消尚未审批通过的预约
以便于 当计划改变时，及时通知被访人，避免资源浪费
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功取消待审批预约
  Given 访客已登录微信公众号
  And 访客有1条状态为"待审批"的预约
  When 访客在预约详情页点击"取消预约"按钮
  And 确认对话框点击"确定"
  Then 预约状态变更为"已取消"
  And 被访人收到"访客已取消预约"的微信模板消息
  And 系统记录取消时间和取消人
  And 操作响应时间≤1秒

Scenario 2: 取消已通过的预约被拦截
  Given 访客已登录微信公众号
  And 访客有1条状态为"已通过"的预约
  When 访客在预约详情页
  Then "取消预约"按钮不可见或不可用
  And 显示提示"已通过的预约无法取消，请联系被访人或安保"

Scenario 3: 取消次数超限拦截
  Given 访客已登录微信公众号
  And 访客当天已取消过3次预约
  When 访客尝试提交新预约
  Then 系统显示错误提示"您今天已取消3次预约，无法再提交新预约"
  And 提交按钮不可用

Scenario 4: 取消预约时填写取消原因
  Given 访客在预约详情页点击"取消预约"按钮
  When 确认对话框弹出
  Then 显示可选的"取消原因"输入框（最多200字）
  When 访客填写原因并点击"确定"
  Then 取消原因记录到数据库
```

**技术实现建议**:

- 前端：微信公众号H5页面，确认对话框（带可选输入框）
- 后端：Spring Boot RESTful API（PUT /api/appointments/{id}/cancel），业务规则校验（状态检查、取消次数校验）
- 数据库：更新appointments表（status='已取消', cancel_time, cancel_reason），访客取消次数记录表（visitor_cancel_log）
- 集成：微信模板消息推送（通知被访人）

**依赖**:

- US-001（必须先能提交预约）
- US-002（从预约详情页进入取消操作）

**风险**:

- 无

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（4个Scenario）
- ✅ 取消操作响应时间≤1秒
- ✅ 产品经理演示通过

---

### US-004: 被访人审批访客预约（一级审批）

**Story ID**: US-004
**Story名称**: 被访人审批访客预约（一级审批）
**Epic**: 访客预约模块
**优先级**: P0
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 1

**用户故事描述**（Who-What-Why格式）:

```
作为 被访人（员工）
我想要 审批访客提交的预约申请
以便于 确认访客来访的合理性，控制自己的访客数量
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功通过预约审批
  Given 被访人已登录微信公众号或管理后台
  And 被访人有1条待审批的访客预约
  When 被访人点击"通过"按钮
  And 可选填写审批意见
  Then 预约的一级审批状态变更为"已通过"
  And 预约进入二级审批流程（转给安保）
  And 访客收到"被访人已通过审批"的微信模板消息
  And 安保收到"新的访客预约待二级审批"的通知

Scenario 2: 拒绝预约审批
  Given 被访人已登录
  And 被访人有1条待审批的访客预约
  When 被访人点击"拒绝"按钮
  And 必须填写拒绝原因（如"时间冲突"）
  Then 预约状态变更为"已拒绝"
  And 访客收到"被访人已拒绝预约"的微信模板消息，包含拒绝原因
  And 审批流程终止（不进入二级审批）

Scenario 3: 查看预约详情后审批
  Given 被访人在审批列表中
  When 被访人点击某条预约记录
  Then 显示预约详情，包括：
    - 访客姓名、手机号、身份证号
    - 访客照片
    - 来访目的、访问时间
    - 车牌号、随行人员（如有）
  When 被访人在详情页点击"通过"或"拒绝"
  Then 审批操作执行

Scenario 4: 只能审批自己的访客预约
  Given 被访人A已登录
  When 被访人A尝试访问被访人B的预约记录
  Then 系统显示"无权限访问"错误提示
  And 无法查看或审批

Scenario 5: 批量审批多条预约
  Given 被访人已登录管理后台
  And 被访人有5条待审批的访客预约
  When 被访人勾选3条预约
  And 点击"批量通过"按钮
  Then 3条预约的一级审批状态均变更为"已通过"
  And 访客和安保分别收到通知
```

**技术实现建议**:

- 前端：微信公众号H5页面 + Web管理后台，审批列表组件，批量操作
- 后端：Spring Boot RESTful API（PUT /api/appointments/{id}/approve），权限校验（只能审批自己的访客）
- 数据库：更新appointments表（first_approve_status='已通过', first_approve_time, first_approve_opinion）
- 集成：微信模板消息推送（通知访客和安保）

**依赖**:

- US-001（必须先能提交预约）

**风险**:

- 无

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 权限校验准确率100%（只能审批自己的访客）
- ✅ 产品经理演示通过

---

### US-005: 安保审批访客预约（二级审批）

**Story ID**: US-005
**Story名称**: 安保审批访客预约（二级审批）
**Epic**: 访客预约模块
**优先级**: P0
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 1

**用户故事描述**（Who-What-Why格式）:

```
作为 安保人员
我想要 审批通过一级审批的访客预约
以便于 从安全角度确认访客身份，控制访客进出权限
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功通过二级审批并下发门禁权限
  Given 安保已登录管理后台
  And 有1条一级审批已通过、待二级审批的预约
  When 安保点击"通过"按钮
  Then 预约状态变更为"已通过"（整体审批完成）
  And 系统自动调用门禁系统API下发权限（访问日期当天有效）
  And 访客收到"预约已通过，请查看签到二维码"的微信模板消息
  And 被访人收到"访客预约已通过"的通知

Scenario 2: 二级审批拒绝
  Given 安保已登录管理后台
  And 有1条待二级审批的预约
  When 安保点击"拒绝"按钮
  And 必须填写拒绝原因（如"黑名单人员"）
  Then 预约状态变更为"已拒绝"
  And 访客收到拒绝通知（包含拒绝原因）
  And 被访人收到拒绝通知
  And 门禁权限不下发

Scenario 3: 黑名单人员自动拦截
  Given 安保在审批列表中
  And 某条预约的访客身份证号在黑名单中
  When 安保查看该预约详情
  Then 系统自动标记"⚠️黑名单人员"
  And 显示历史违规记录
  And 建议拒绝审批

Scenario 4: 门禁权限下发失败处理
  Given 安保点击"通过"按钮
  When 调用门禁系统API失败（如网络超时）
  Then 预约状态标记为"审批通过，权限下发失败"
  And 系统记录失败原因
  And 安保收到"门禁权限下发失败"告警
  And 提供"重新下发权限"按钮

Scenario 5: 批量审批多条预约
  Given 安保已登录管理后台
  And 有10条待二级审批的预约
  When 安保勾选5条预约
  And 点击"批量通过"按钮
  Then 5条预约状态均变更为"已通过"
  And 批量调用门禁系统API下发权限
  And 访客和被访人分别收到通知
```

**技术实现建议**:

- 前端：Web管理后台（React/Vue.js），审批列表组件，黑名单标识
- 后端：Spring Boot RESTful API（PUT /api/appointments/{id}/final-approve），门禁系统集成（HTTP Client）
- 数据库：更新appointments表（status='已通过', final_approve_status='已通过', access_control_status='已下发'），黑名单表（blacklist）关联查询
- 集成：门禁系统API（下发临时权限），微信模板消息推送

**依赖**:

- US-004（必须先完成一级审批）
- 门禁系统API开发完成

**风险**:

- 门禁系统API可用性（需要重试机制和人工兜底）

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 门禁权限下发成功率≥95%
- ✅ 产品经理演示通过

---

### US-006: 团队访客批量预约

**Story ID**: US-006
**Story名称**: 团队访客批量预约
**Epic**: 访客预约模块
**优先级**: P1
**故事点**: 5点（4-5天完成）
**迭代**: Sprint 2

**用户故事描述**（Who-What-Why格式）:

```
作为 被访人
我想要 为团队访客批量创建预约（如会议、培训、参观团）
以便于 避免逐个填写访客信息，节省批量预约时间
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 成功通过表单批量创建预约
  Given 被访人已登录管理后台
  When 被访人点击"创建团队预约"
  And 填写团队基本信息（团队名称、来访目的、访问时间）
  And 批量添加5个访客信息（姓名、手机号、身份证号）
  And 点击"提交"按钮
  Then 系统生成5条预约记录
  And 预约单号格式为YY20251127T001-01~05
  And 所有预约关联到同一团队预约ID
  And 预约状态为"待审批"
  And 操作时间≤10秒

Scenario 2: Excel导入批量创建预约（V2.0扩展）
  Given 被访人已登录管理后台
  When 被访人下载Excel模板
  And 填写20个访客信息
  And 上传Excel文件
  Then 系统自动解析Excel
  And 生成20条预约记录
  And 显示解析结果（成功X条，失败Y条）
  And 错误行给出明确提示（如"第3行手机号格式错误"）

Scenario 3: 团队预约整体审批
  Given 有1个团队预约（包含5个访客）
  When 被访人审批通过
  Then 5条预约的一级审批状态均变更为"已通过"
  And 进入二级审批流程
  When 安保审批拒绝其中1个访客（如黑名单人员）
  Then 该访客预约状态变更为"已拒绝"
  And 其他4个访客不受影响，继续审批流程

Scenario 4: 单次团队预约人数限制
  Given 被访人在批量添加访客信息
  When 被访人尝试添加第21个访客
  Then 系统显示错误提示"单次团队预约最多支持20人"
  And 第21个访客无法添加

Scenario 5: 团队预约通知合并发送
  Given 有1个团队预约（包含5个访客）
  When 被访人审批通过
  Then 被访人收到1条合并通知"您的团队预约（5人）待安保审批"
  And 不发送5条单独通知
```

**技术实现建议**:

- 前端：Web管理后台，批量添加表单组件，Excel导入组件（xlsx.js）
- 后端：Spring Boot RESTful API（POST /api/appointments/team），Excel解析（Apache POI），事务处理（批量插入）
- 数据库：appointments表新增team_id字段，团队预约表（team_appointments）
- 集成：微信模板消息推送（合并通知）

**依赖**:

- US-001（复用单个预约的基础逻辑）
- US-004、US-005（复用审批流程）

**风险**:

- Excel解析准确性（需要详细的错误提示）
- 批量插入性能（20条记录需≤10秒）

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ Excel导入解析准确率≥95%
- ✅ 产品经理演示通过

---

### US-007: 审批流程自定义配置

**Story ID**: US-007
**Story名称**: 审批流程自定义配置
**Epic**: 访客预约模块
**优先级**: P1
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 2

**用户故事描述**（Who-What-Why格式）:

```
作为 系统管理员
我想要 配置访客预约的审批流程规则
以便于 根据不同场景（如VIP访客、普通访客、供应商）使用不同的审批流程
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 配置单级审批流程（VIP访客免二级审批）
  Given 管理员已登录管理后台
  When 管理员进入"审批流程配置"页面
  And 选择"VIP访客"场景
  And 配置审批流程为"仅被访人审批"
  And 保存配置
  Then 系统记录配置规则
  When VIP访客提交预约（来访目的选择"VIP"）
  And 被访人审批通过
  Then 预约状态直接变更为"已通过"
  And 跳过二级审批
  And 自动下发门禁权限

Scenario 2: 配置三级审批流程（敏感访客需主管审批）
  Given 管理员配置"敏感访客"场景
  And 审批流程为"被访人审批 → 被访人主管审批 → 安保审批"
  When 敏感访客提交预约
  And 被访人审批通过
  Then 预约进入"待主管审批"状态
  And 被访人主管收到审批通知
  When 主管审批通过
  Then 预约进入二级审批流程

Scenario 3: 白名单访客免审批
  Given 管理员配置"白名单访客"场景
  And 审批流程为"自动通过"
  When 白名单访客（身份证号在白名单中）提交预约
  Then 系统自动审批通过（跳过所有审批）
  And 直接下发门禁权限
  And 通知被访人"白名单访客预约已自动通过"

Scenario 4: 查看审批流程配置历史
  Given 管理员在"审批流程配置"页面
  When 管理员点击"配置历史"
  Then 显示所有配置变更记录（时间、操作人、变更内容）
```

**技术实现建议**:

- 前端：Web管理后台，流程配置组件（拖拽式流程设计）
- 后端：Spring Boot，规则引擎（Drools或自定义规则表），动态审批流程执行
- 数据库：审批流程配置表（approval_workflow_config），审批流程历史表（approval_workflow_history）
- 集成：无

**依赖**:

- US-004、US-005（复用现有审批逻辑）

**风险**:

- 规则引擎复杂度（需要充分测试各种场景）

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（4个Scenario）
- ✅ 至少支持3种审批流程场景（单级、双级、三级）
- ✅ 产品经理演示通过

---

### US-008: 访客黑白名单管理

**Story ID**: US-008
**Story名称**: 访客黑白名单管理
**Epic**: 访客预约模块
**优先级**: P1
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 2

**用户故事描述**（Who-What-Why格式）:

```
作为 安保人员
我想要 管理访客黑名单和白名单
以便于 自动拦截黑名单人员预约，简化白名单VIP访客审批流程
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 添加黑名单人员
  Given 安保已登录管理后台
  When 安保进入"黑名单管理"页面
  And 点击"添加黑名单"
  And 填写身份证号、姓名、拉黑原因、拉黑时长（永久/临时）
  And 点击"保存"
  Then 系统记录黑名单信息
  And 黑名单生效
  When 该访客尝试提交预约
  Then 系统自动拦截并提示"您已被加入黑名单，无法预约"

Scenario 2: 黑名单人员预约自动拦截
  Given 访客A的身份证号在黑名单中
  When 访客A填写预约信息（身份证号）
  And 点击"提交预约"
  Then 系统显示错误提示"该身份证号已被加入黑名单，无法预约。如有疑问请联系安保。"
  And 预约未提交

Scenario 3: 添加白名单VIP访客
  Given 安保已登录管理后台
  When 安保进入"白名单管理"页面
  And 点击"添加白名单"
  And 填写身份证号、姓名、VIP等级、有效期
  And 点击"保存"
  Then 系统记录白名单信息
  When 该访客提交预约
  Then 系统自动通过审批（根据US-007配置）

Scenario 4: 移除黑名单/白名单
  Given 安保在黑名单/白名单列表中
  When 安保选择某条记录
  And 点击"移除"按钮
  And 确认操作
  Then 该人员从黑名单/白名单中移除
  And 恢复正常审批流程

Scenario 5: 黑白名单Excel批量导入
  Given 安保已登录管理后台
  When 安保下载Excel模板
  And 填写100条黑名单人员信息
  And 上传Excel
  Then 系统批量导入黑名单
  And 显示导入结果（成功X条，失败Y条）
```

**技术实现建议**:

- 前端：Web管理后台，黑白名单管理页面，Excel导入组件
- 后端：Spring Boot RESTful API，黑白名单校验拦截器
- 数据库：黑名单表（blacklist），白名单表（whitelist）
- 集成：无

**依赖**:

- US-001（在预约提交时校验黑名单）
- US-007（白名单自动审批规则）

**风险**:

- 无

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 黑名单拦截准确率100%
- ✅ 产品经理演示通过

---

### US-009: 访客预约数据统计分析

**Story ID**: US-009
**Story名称**: 访客预约数据统计分析
**Epic**: 访客预约模块
**优先级**: P2
**故事点**: 3点（2-3天完成）
**迭代**: Sprint 3

**用户故事描述**（Who-What-Why格式）:

```
作为 园区运营管理人员
我想要 查看访客预约数据统计报表
以便于 了解访客来访趋势、热门时段、审批效率，支持运营决策
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 查看访客预约趋势图
  Given 运营人员已登录管理后台
  When 运营人员进入"数据统计"页面
  And 选择时间范围（最近30天）
  Then 显示访客预约趋势折线图（按日期统计预约数量）
  And 区分已通过、已拒绝、待审批状态
  And 图表加载时间≤3秒

Scenario 2: 查看热门时段分布
  Given 运营人员在"数据统计"页面
  When 运营人员点击"时段分布"Tab
  Then 显示24小时时段分布柱状图（统计访问时段）
  And 标识高峰时段（如9-11点、14-16点）

Scenario 3: 查看被访人排行榜
  Given 运营人员在"数据统计"页面
  When 运营人员点击"被访人排行"Tab
  Then 显示被访人接待访客数量排行（Top 10）
  And 展示姓名、部门、接待数量

Scenario 4: 导出统计报表
  Given 运营人员查看统计数据
  When 运营人员点击"导出Excel"按钮
  Then 下载包含以下数据的Excel报表：
    - 预约总数、通过率、拒绝率
    - 时段分布数据
    - 被访人排行数据
  And 导出时间≤5秒

Scenario 5: 查看审批效率指标
  Given 运营人员在"数据统计"页面
  When 运营人员点击"审批效率"Tab
  Then 显示以下指标：
    - 平均审批时长（从提交到最终通过/拒绝）
    - 一级审批平均时长、二级审批平均时长
    - 超时预约数量（>24小时未审批）
```

**技术实现建议**:

- 前端：Web管理后台，数据可视化组件（ECharts/Chart.js）
- 后端：Spring Boot，数据聚合查询（GROUP BY + 时间函数），定时任务（每日统计）
- 数据库：预约统计表（appointment_statistics，定时汇总），原始数据查询appointments表
- 集成：Excel导出（Apache POI）

**依赖**:

- 所有预约和审批功能（需要积累数据）

**风险**:

- 数据量大时查询性能（需要索引优化和汇总表）

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 图表加载时间≤3秒（10万条数据）
- ✅ 产品经理演示通过

---

### US-010: 访客预约提醒推送

**Story ID**: US-010
**Story名称**: 访客预约提醒推送
**Epic**: 访客预约模块
**优先级**: P2
**故事点**: 2点（1-2天完成）
**迭代**: Sprint 3

**用户故事描述**（Who-What-Why格式）:

```
作为 访客和被访人
我想要 在预约相关时间节点收到提醒通知
以便于 及时处理审批、准时到访，避免遗漏或迟到
```

**验收标准**（Given-When-Then格式）:

```gherkin
Scenario 1: 访客预约前1天提醒
  Given 访客有1条状态为"已通过"的预约
  And 访问日期为明天
  When 系统定时任务执行（每天20:00）
  Then 访客收到微信模板消息"您明天有访客预约，访问时间{XX:XX}"
  And 提醒包含签到二维码链接

Scenario 2: 被访人预约当天提醒
  Given 被访人有3条访客预约（今天）
  When 系统定时任务执行（每天8:00）
  Then 被访人收到微信模板消息"您今天有3位访客来访"
  And 提醒包含访客姓名和访问时间

Scenario 3: 审批超时提醒
  Given 被访人有1条待审批的预约
  And 预约提交已超过24小时未处理
  When 系统定时任务执行（每小时检查一次）
  Then 被访人收到微信模板消息"您有1条预约超时未审批，请及时处理"
  And 提醒包含预约详情链接

Scenario 4: 访客签到超时提醒
  Given 访客预约已通过
  And 访问时间已过30分钟但未签到
  When 系统定时任务执行（每10分钟检查一次）
  Then 被访人收到微信模板消息"访客{姓名}预约时间已到，但未签到"

Scenario 5: 提醒推送失败重试
  Given 系统向访客发送提醒通知
  When 微信接口返回失败（如用户取消关注）
  Then 系统记录发送失败日志
  And 30分钟后重试1次
  And 如仍失败则标记为"推送失败"
```

**技术实现建议**:

- 前端：无（后端定时任务）
- 后端：Spring Boot定时任务（@Scheduled），微信模板消息推送
- 数据库：消息推送记录表（message_push_log）
- 集成：微信模板消息API

**依赖**:

- US-001、US-004、US-005（预约和审批数据）

**风险**:

- 微信模板消息推送限制（每月1000条，超出需付费）

**Definition of Done (DoD)**:

- ✅ 代码完成并通过代码审查
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 所有验收标准通过（5个Scenario）
- ✅ 提醒推送准时率≥95%（±5分钟内）
- ✅ 产品经理演示通过

---

## 第3部分：优先级和依赖关系

### 优先级排序表

| 优先级 | Story ID | Story名称            | 理由                             |
| ------ | -------- | -------------------- | -------------------------------- |
| 1      | US-001   | 访客在线提交预约申请 | 核心功能，所有流程的起点         |
| 2      | US-004   | 被访人审批访客预约   | 核心功能，完成一级审批闭环       |
| 3      | US-005   | 安保审批访客预约     | 核心功能，完成审批闭环和门禁集成 |
| 4      | US-002   | 访客查询预约记录     | 核心功能，提升用户体验           |
| 5      | US-003   | 访客取消待审批预约   | 重要功能，完善预约流程           |
| 6      | US-006   | 团队访客批量预约     | 增强功能，提升批量场景效率       |
| 7      | US-007   | 审批流程自定义配置   | 增强功能，提升灵活性             |
| 8      | US-008   | 访客黑白名单管理     | 增强功能，提升安全性             |
| 9      | US-009   | 访客预约数据统计分析 | 优化功能，运营决策支持           |
| 10     | US-010   | 访客预约提醒推送     | 优化功能，提升用户体验           |

**排序依据**：

- P0故事优先（US-001/002/004/005）：构建MVP核心流程
- 被依赖的Story优先（US-001是所有Story的基础）
- 功能完整性优先（先完成端到端流程，再增强细节）

---

### 依赖关系图

```
US-001 (访客提交预约) - 核心起点
  ├─> US-002 (查询预约记录)
  ├─> US-003 (取消预约)
  ├─> US-004 (被访人审批)
  │     └─> US-005 (安保审批)
  │           └─> US-007 (审批流程配置)
  ├─> US-006 (团队批量预约)
  ├─> US-008 (黑白名单管理)
  ├─> US-009 (数据统计)
  └─> US-010 (提醒推送)
```

**依赖说明**：

- US-001是所有Story的基础（必须最先完成）
- US-004和US-005有强依赖关系（审批流程顺序）
- US-006复用US-001的预约逻辑（技术依赖）
- US-009和US-010依赖数据积累（可延后实现）

---

## 第4部分：迭代计划建议

### Sprint 1（4周）- MVP核心功能

- US-001: 访客在线提交预约申请（5点）
- US-002: 访客查询预约记录（3点）
- US-003: 访客取消待审批预约（2点）
- US-004: 被访人审批访客预约（3点）
- US-005: 安保审批访客预约（3点）
- **总计**: 16点 ≈ 4周工作量（团队3人，每人每周完成约1.3点）

**交付成果**: 访客可在线预约、被访人和安保完成审批、门禁权限自动下发，实现端到端预约流程

---

### Sprint 2（3周）- 增强功能

- US-006: 团队访客批量预约（5点）
- US-007: 审批流程自定义配置（3点）
- US-008: 访客黑白名单管理（3点）
- **总计**: 11点 ≈ 3周工作量

**交付成果**: 支持团队批量预约、灵活配置审批流程、自动拦截黑名单人员

---

### Sprint 3（2周）- 优化功能

- US-009: 访客预约数据统计分析（3点）
- US-010: 访客预约提醒推送（2点）
- **总计**: 5点 ≈ 2周工作量

**交付成果**: 运营数据可视化、智能提醒推送，完善用户体验
