<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¿å®¢é¢„çº¦ç”³è¯· - è®¿å®¢ç®¡ç†ç³»ç»Ÿ</title>
    
    <style>
        /* ========== Ant Designé£æ ¼æ ·å¼ ========== */
        :root {
            --primary-color: #1890ff;
            --primary-hover: #40a9ff;
            --primary-active: #096dd9;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --text-color: rgba(0, 0, 0, 0.85);
            --text-secondary: rgba(0, 0, 0, 0.65);
            --text-disabled: rgba(0, 0, 0, 0.25);
            --border-color: #d9d9d9;
            --border-color-light: #f0f0f0;
            --background-color: #f0f2f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5715;
            font-size: 14px;
        }
        
        .page-container {
            min-height: 100vh;
            padding: 24px 16px;
        }
        
        .container {
            max-width: 680px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
            padding: 24px;
        }
        
        /* é¡µé¢å¤´éƒ¨ */
        .header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color-light);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .required-mark {
            color: var(--error-color);
            margin-right: 4px;
        }
        
        /* è¡¨å•åŒºåŸŸ */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color-light);
        }
        
        .form-section:last-of-type {
            border-bottom: none;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 16px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-color);
            font-weight: normal;
        }
        
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 4px 11px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            font-size: 14px;
            color: var(--text-color);
            background-color: #fff;
            transition: all 0.3s;
        }
        
        .form-group textarea {
            height: auto;
            min-height: 80px;
            padding: 8px 11px;
            resize: vertical;
        }
        
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--primary-hover);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #bfbfbf;
        }
        
        /* é”™è¯¯çŠ¶æ€ */
        .form-group.has-error input,
        .form-group.has-error select,
        .form-group.has-error textarea {
            border-color: var(--error-color);
        }
        
        .form-group.has-error input:focus,
        .form-group.has-error select:focus,
        .form-group.has-error textarea:focus {
            box-shadow: 0 0 0 2px rgba(255, 77, 79, 0.2);
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
            line-height: 1.5715;
        }
        
        .form-group.has-error .error-message {
            display: block;
        }
        
        /* ç…§ç‰‡ä¸Šä¼ ç»„ä»¶ */
        .photo-upload {
            display: inline-block;
        }
        
        .upload-btn {
            width: 120px;
            height: 160px;
            border: 1px dashed var(--border-color);
            border-radius: 2px;
            background-color: #fafafa;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            border-color: var(--primary-color);
        }
        
        .upload-btn .icon {
            font-size: 32px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .upload-btn .text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .photo-preview {
            position: relative;
            width: 120px;
            height: 160px;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        
        .photo-preview.show {
            display: block;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-preview .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }
        
        .photo-preview .delete-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .upload-tip {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* è¢«è®¿äººæœç´¢ç»„ä»¶ */
        .search-wrapper {
            position: relative;
        }
        
        .search-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 2px 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 100;
        }
        
        .search-list.show {
            display: block;
        }
        
        .search-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .search-item:hover {
            background: #f5f5f5;
        }
        
        .search-item .name {
            font-size: 14px;
            color: var(--text-color);
        }
        
        .search-item .dept {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        
        .search-item .emp-no {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        
        .search-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .selected-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #f0f5ff;
            border: 1px solid #adc6ff;
            border-radius: 2px;
            font-size: 14px;
            color: var(--primary-color);
            display: none;
        }
        
        .selected-tag.show {
            display: inline-flex;
        }
        
        .selected-tag .tag-close {
            margin-left: 8px;
            cursor: pointer;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        .selected-tag .tag-close:hover {
            color: var(--primary-active);
        }
        
        /* å•é€‰æ¡†ç»„ */
        .radio-group {
            display: flex;
            gap: 24px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .radio-item label {
            margin: 0;
            cursor: pointer;
        }
        
        /* æŒ‰é’® */
        .btn {
            height: 32px;
            padding: 4px 15px;
            border: 1px solid transparent;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
            user-select: none;
            line-height: 1.5715;
            display: inline-block;
            font-weight: 400;
            white-space: nowrap;
            text-align: center;
            background: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.043);
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        
        .btn-primary:active {
            background-color: var(--primary-active);
            border-color: var(--primary-active);
        }
        
        .btn-primary:disabled {
            background-color: #f5f5f5;
            border-color: var(--border-color);
            color: var(--text-disabled);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .form-actions {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color-light);
        }
        
        /* Toastæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 16px;
            border-radius: 2px;
            box-shadow: 0 3px 6px -4px rgba(0, 0, 0, 0.12), 
                        0 6px 16px 0 rgba(0, 0, 0, 0.08), 
                        0 9px 28px 8px rgba(0, 0, 0, 0.05);
            background: #fff;
            font-size: 14px;
            line-height: 1.5715;
            z-index: 2000;
            display: none;
            animation: slideInDown 0.2s ease-out;
        }
        
        .toast.show {
            display: block;
        }
        
        .toast.success {
            color: var(--success-color);
        }
        
        .toast.success::before {
            content: "âœ“ ";
            font-weight: bold;
            margin-right: 8px;
        }
        
        .toast.error {
            color: var(--error-color);
        }
        
        .toast.error::before {
            content: "âœ• ";
            font-weight: bold;
            margin-right: 8px;
        }
        
        /* è­¦å‘Šæ¡ */
        .alert {
            padding: 8px 15px;
            border-radius: 2px;
            margin-bottom: 16px;
            display: none;
        }
        
        .alert.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert.warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
        }
        
        .alert .alert-close {
            cursor: pointer;
            font-size: 12px;
            margin-left: 12px;
        }
        
        /* åŠ è½½é®ç½© */
        .loading-mask {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-mask.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            color: #fff;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* ç…§ç‰‡ä¸Šä¼ å¼¹çª—ï¼ˆæ¨¡æ‹ŸP3ï¼‰ */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1500;
            align-items: flex-end;
            justify-content: center;
        }
        
        .photo-modal.show {
            display: flex;
            animation: fadeIn 0.25s ease-out;
        }
        
        .photo-modal-content {
            background: #fff;
            border-radius: 8px 8px 0 0;
            width: 100%;
            max-width: 680px;
            animation: slideUp 0.25s ease-out;
        }
        
        .photo-modal-menu {
            padding: 0;
        }
        
        .photo-modal-item {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color-light);
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            transition: background 0.3s;
        }
        
        .photo-modal-item:hover {
            background: #f5f5f5;
        }
        
        .photo-modal-item.cancel {
            color: var(--text-secondary);
            border-bottom: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .page-container {
                padding: 16px 12px;
            }
            
            .container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!--
        ã€åŸå‹è¯´æ˜ã€‘
        - è¿™æ˜¯US-001"è®¿å®¢åœ¨çº¿æäº¤é¢„çº¦ç”³è¯·"çš„äº¤äº’åŸå‹
        - UIé£æ ¼ï¼šé‡‡ç”¨Ant Designè®¾è®¡è§„èŒƒ
        - æ•°æ®æäº¤ä¸ºæ¨¡æ‹Ÿå®ç°ï¼Œä½¿ç”¨localStorageå­˜å‚¨
        - ç…§ç‰‡ä¸Šä¼ ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨æ¨¡æ‹Ÿï¼ˆå®é™…åº”è°ƒç”¨å¾®ä¿¡JSSDKï¼‰
        - ä»…æ”¯æŒç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Edgeã€Firefoxã€Safariï¼‰
    -->
    
    <!-- Toastæ¶ˆæ¯æç¤º -->
    <div class="toast" id="toast"></div>
    
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-mask" id="loadingMask">
        <div class="loading-content">
            <div class="spinner"></div>
            <div>æ­£åœ¨æäº¤é¢„çº¦...</div>
        </div>
    </div>
    
    <!-- ç…§ç‰‡ä¸Šä¼ å¼¹çª—ï¼ˆæ¨¡æ‹ŸP3ï¼‰ -->
    <div class="photo-modal" id="photoModal">
        <div class="photo-modal-content">
            <div class="photo-modal-menu">
                <div class="photo-modal-item" id="takePhoto">ğŸ“· æ‹ç…§</div>
                <div class="photo-modal-item" id="choosePhoto">ğŸ–¼ï¸ ä»ç›¸å†Œé€‰æ‹©</div>
                <div class="photo-modal-item cancel" id="cancelPhoto">å–æ¶ˆ</div>
            </div>
        </div>
    </div>
    
    <!-- é¡µé¢ä¸»å®¹å™¨ -->
    <div class="page-container">
        <div class="container">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="header">
                <h1>è®¿å®¢é¢„çº¦ç”³è¯·</h1>
                <p>è¯·å¦‚å®å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œå¸¦<span class="required-mark">*</span>ä¸ºå¿…å¡«é¡¹</p>
            </div>
            
            <!-- é‡å¤æäº¤è­¦å‘Š -->
            <div class="alert warning" id="duplicateAlert">
                <span>âš ï¸ æ‚¨ä»Šå¤©å·²æäº¤è¿‡é¢„çº¦ï¼ŒåŒä¸€å¤©åªèƒ½æäº¤1æ¬¡</span>
                <span class="alert-close" onclick="this.parentElement.classList.remove('show')">âœ•</span>
            </div>
            
            <!-- è¡¨å• -->
            <form id="appointmentForm" novalidate>
                <!-- ä¸ªäººä¿¡æ¯åŒºåŸŸ -->
                <div class="form-section">
                    <h2 class="form-section-title">ä¸ªäººä¿¡æ¯</h2>
                    
                    <!-- F1: è®¿å®¢å§“å -->
                    <div class="form-group" data-field="visitorName">
                        <label for="visitorName">
                            <span class="required-mark">*</span>è®¿å®¢å§“å
                        </label>
                        <input 
                            type="text" 
                            id="visitorName" 
                            name="visitorName"
                            placeholder="è¯·è¾“å…¥çœŸå®å§“å"
                            maxlength="20"
                            required
                            data-validate="name"
                        />
                        <div class="error-message">è¯·å¡«å†™è®¿å®¢å§“å</div>
                    </div>
                    
                    <!-- F2: æ‰‹æœºå·ç  -->
                    <div class="form-group" data-field="visitorPhone">
                        <label for="visitorPhone">
                            <span class="required-mark">*</span>æ‰‹æœºå·ç 
                        </label>
                        <input 
                            type="text" 
                            id="visitorPhone" 
                            name="visitorPhone"
                            placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·"
                            maxlength="11"
                            required
                            data-validate="phone"
                        />
                        <div class="error-message">æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å¡«å†™11ä½æ‰‹æœºå·</div>
                    </div>
                    
                    <!-- F3: èº«ä»½è¯å· -->
                    <div class="form-group" data-field="visitorIdCard">
                        <label for="visitorIdCard">
                            <span class="required-mark">*</span>èº«ä»½è¯å·
                        </label>
                        <input 
                            type="text" 
                            id="visitorIdCard" 
                            name="visitorIdCard"
                            placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·"
                            maxlength="18"
                            required
                            data-validate="idCard"
                        />
                        <div class="error-message">èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å¡«å†™18ä½èº«ä»½è¯å·</div>
                    </div>
                    
                    <!-- F4: è®¿å®¢ç…§ç‰‡ -->
                    <div class="form-group" data-field="visitorPhoto">
                        <label>
                            <span class="required-mark">*</span>è®¿å®¢ç…§ç‰‡
                        </label>
                        <div class="photo-upload">
                            <div class="upload-btn" id="uploadBtn">
                                <div class="icon">ğŸ“·</div>
                                <div class="text">ä¸Šä¼ ç…§ç‰‡</div>
                            </div>
                            <div class="photo-preview" id="photoPreview">
                                <img id="photoImg" src="" alt="è®¿å®¢ç…§ç‰‡">
                                <button type="button" class="delete-btn" id="deletePhoto">âœ•</button>
                            </div>
                        </div>
                        <div class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œæ–‡ä»¶ä¸è¶…è¿‡5MB</div>
                        <input type="file" id="photoInput" accept="image/jpeg,image/png" style="display: none;">
                        <input type="hidden" id="visitorPhoto" name="visitorPhoto" required>
                        <div class="error-message">è¯·ä¸Šä¼ æœ¬äººè¿‘æœŸç…§ç‰‡</div>
                    </div>
                </div>
                
                <!-- æ¥è®¿ä¿¡æ¯åŒºåŸŸ -->
                <div class="form-section">
                    <h2 class="form-section-title">æ¥è®¿ä¿¡æ¯</h2>
                    
                    <!-- F5: æ¥è®¿ç›®çš„ -->
                    <div class="form-group" data-field="visitPurpose">
                        <label for="visitPurpose">
                            <span class="required-mark">*</span>æ¥è®¿ç›®çš„
                        </label>
                        <select 
                            id="visitPurpose" 
                            name="visitPurpose"
                            required
                        >
                            <option value="">è¯·é€‰æ‹©æ¥è®¿ç›®çš„</option>
                            <option value="ä¸šåŠ¡æ´½è°ˆ">ä¸šåŠ¡æ´½è°ˆ</option>
                            <option value="å‚è§‚è€ƒå¯Ÿ">å‚è§‚è€ƒå¯Ÿ</option>
                            <option value="é¢è¯•æ‹›è˜">é¢è¯•æ‹›è˜</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                        <div class="error-message">è¯·é€‰æ‹©æ¥è®¿ç›®çš„</div>
                    </div>
                    
                    <!-- F6: å…¶ä»–è¯´æ˜ -->
                    <div class="form-group" id="otherDescGroup" style="display: none;" data-field="visitPurposeDesc">
                        <label for="visitPurposeDesc">
                            <span class="required-mark">*</span>å…¶ä»–è¯´æ˜
                        </label>
                        <textarea 
                            id="visitPurposeDesc" 
                            name="visitPurposeDesc"
                            placeholder="è‹¥é€‰æ‹©"å…¶ä»–"ï¼Œè¯·è¯´æ˜å…·ä½“äº‹ç”±"
                            maxlength="200"
                        ></textarea>
                        <div class="error-message">è¯·è¯´æ˜å…·ä½“äº‹ç”±</div>
                    </div>
                    
                    <!-- F7: è®¿é—®æ—¥æœŸ -->
                    <div class="form-group" data-field="visitDate">
                        <label for="visitDate">
                            <span class="required-mark">*</span>è®¿é—®æ—¥æœŸ
                        </label>
                        <input 
                            type="date" 
                            id="visitDate" 
                            name="visitDate"
                            required
                            data-validate="date"
                        />
                        <div class="error-message">è¯·é€‰æ‹©è®¿é—®æ—¥æœŸ</div>
                    </div>
                    
                    <!-- F8: è®¿é—®æ—¶æ®µ -->
                    <div class="form-group" data-field="visitTimeSlot">
                        <label>
                            <span class="required-mark">*</span>è®¿é—®æ—¶æ®µ
                        </label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="timeAm" name="visitTimeSlot" value="ä¸Šåˆ" required>
                                <label for="timeAm">ä¸Šåˆ(8:00-12:00)</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="timePm" name="visitTimeSlot" value="ä¸‹åˆ" required>
                                <label for="timePm">ä¸‹åˆ(13:00-18:00)</label>
                            </div>
                        </div>
                        <div class="error-message">è¯·é€‰æ‹©è®¿é—®æ—¶æ®µ</div>
                    </div>
                    
                    <!-- F9: è¢«è®¿äºº -->
                    <div class="form-group" data-field="visiteeId">
                        <label for="visiteeSearch">
                            <span class="required-mark">*</span>è¢«è®¿äºº
                        </label>
                        <div class="search-wrapper">
                            <input 
                                type="text" 
                                id="visiteeSearch" 
                                placeholder="è¯·è¾“å…¥è¢«è®¿äººå§“åæˆ–å·¥å·"
                                autocomplete="off"
                            />
                            <div class="search-list" id="searchList"></div>
                        </div>
                        <div class="selected-tag" id="selectedTag">
                            <span id="selectedName"></span>
                            <span class="tag-close" id="clearVisitee">âœ•</span>
                        </div>
                        <input type="hidden" id="visiteeId" name="visiteeId" required>
                        <div class="error-message">è¯·é€‰æ‹©è¢«è®¿äºº</div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                        æäº¤é¢„çº¦
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ========== æ¨¡æ‹Ÿæ•°æ® ==========
        
        // æ¨¡æ‹Ÿå‘˜å·¥åˆ—è¡¨ï¼ˆè¢«è®¿äººæ•°æ®ï¼‰
        const employees = [
            { id: 1, name: 'å¼ ä¸‰', dept: 'æŠ€æœ¯éƒ¨', empNo: 'E001' },
            { id: 2, name: 'æå››', dept: 'äº§å“éƒ¨', empNo: 'E002' },
            { id: 3, name: 'ç‹äº”', dept: 'å¸‚åœºéƒ¨', empNo: 'E003' },
            { id: 4, name: 'èµµå…­', dept: 'äººåŠ›èµ„æºéƒ¨', empNo: 'E004' },
            { id: 5, name: 'é’±ä¸ƒ', dept: 'è´¢åŠ¡éƒ¨', empNo: 'E005' },
            { id: 6, name: 'å­™å…«', dept: 'æŠ€æœ¯éƒ¨', empNo: 'E006' },
            { id: 7, name: 'å‘¨ä¹', dept: 'è¿è¥éƒ¨', empNo: 'E007' },
            { id: 8, name: 'å´å', dept: 'å®¢æœéƒ¨', empNo: 'E008' }
        ];
        
        // ========== å·¥å…·å‡½æ•° ==========
        
        // æ˜¾ç¤ºToastæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, type === 'success' ? 2000 : 3000);
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½é®ç½©
        function showLoading(show) {
            const mask = document.getElementById('loadingMask');
            mask.classList.toggle('show', show);
        }
        
        // è¡¨å•éªŒè¯å™¨
        const validators = {
            // å§“åéªŒè¯
            name: (value) => {
                const regex = /^[\u4e00-\u9fa5a-zA-ZÂ·]{2,20}$/;
                if (!value.trim()) return 'è¯·å¡«å†™è®¿å®¢å§“å';
                if (!regex.test(value)) return 'å§“åé•¿åº¦ä¸º2-20ä¸ªå­—ç¬¦ï¼Œæ”¯æŒä¸­è‹±æ–‡';
                return null;
            },
            
            // æ‰‹æœºå·éªŒè¯
            phone: (value) => {
                const regex = /^1[3-9]\d{9}$/;
                if (!value.trim()) return 'è¯·å¡«å†™æ‰‹æœºå·ç ';
                if (!regex.test(value)) return 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å¡«å†™11ä½æ‰‹æœºå·';
                return null;
            },
            
            // èº«ä»½è¯å·éªŒè¯
            idCard: (value) => {
                const regex = /^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/;
                if (!value.trim()) return 'è¯·å¡«å†™èº«ä»½è¯å·';
                if (!regex.test(value)) return 'èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·å¡«å†™18ä½èº«ä»½è¯å·';
                return null;
            },
            
            // æ—¥æœŸéªŒè¯
            date: (value) => {
                if (!value) return 'è¯·é€‰æ‹©è®¿é—®æ—¥æœŸ';
                
                const selectedDate = new Date(value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const maxDate = new Date(today);
                maxDate.setDate(maxDate.getDate() + 30);
                
                if (selectedDate < today) return 'è®¿é—®æ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©';
                if (selectedDate > maxDate) return 'è®¿é—®æ—¥æœŸä¸èƒ½è¶…è¿‡30å¤©å';
                
                return null;
            },
            
            // å¿…å¡«éªŒè¯
            required: (value) => {
                return value && value.trim() !== '' ? null : 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹';
            }
        };
        
        // éªŒè¯å•ä¸ªå­—æ®µ
        function validateField(field) {
            const formGroup = field.closest('.form-group');
            if (!formGroup) return true;
            
            const errorEl = formGroup.querySelector('.error-message');
            const validateType = field.dataset.validate;
            
            // æ¸…é™¤é”™è¯¯çŠ¶æ€
            formGroup.classList.remove('has-error');
            
            // å¿…å¡«éªŒè¯
            if (field.hasAttribute('required')) {
                const error = validators.required(field.value);
                if (error) {
                    formGroup.classList.add('has-error');
                    if (errorEl) {
                        const originalError = errorEl.textContent;
                        errorEl.textContent = error;
                        // æ¢å¤åŸå§‹é”™è¯¯ä¿¡æ¯
                        setTimeout(() => {
                            if (!formGroup.classList.contains('has-error')) {
                                errorEl.textContent = originalError;
                            }
                        }, 100);
                    }
                    return false;
                }
            }
            
            // ç‰¹å®šç±»å‹éªŒè¯
            if (validateType && validators[validateType]) {
                const error = validators[validateType](field.value);
                if (error) {
                    formGroup.classList.add('has-error');
                    if (errorEl) errorEl.textContent = error;
                    return false;
                }
            }
            
            return true;
        }
        
        // éªŒè¯æ•´ä¸ªè¡¨å•
        function validateForm() {
            let isValid = true;
            let firstErrorField = null;
            
            // éªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µ
            const fields = document.querySelectorAll('[required]');
            fields.forEach(field => {
                if (field.type === 'hidden' || field.type === 'file') {
                    // ç‰¹æ®Šå¤„ç†hiddenå’Œfileå­—æ®µ
                    const formGroup = field.closest('.form-group');
                    if (formGroup && !field.value) {
                        formGroup.classList.add('has-error');
                        isValid = false;
                        if (!firstErrorField) firstErrorField = formGroup;
                    }
                } else if (!validateField(field)) {
                    isValid = false;
                    if (!firstErrorField) firstErrorField = field;
                }
            });
            
            // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å­—æ®µ
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return isValid;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²æäº¤
        function checkDuplicateSubmission() {
            const submissions = JSON.parse(localStorage.getItem('appointments') || '[]');
            const today = new Date().toDateString();
            
            const todaySubmission = submissions.find(s => {
                const submitDate = new Date(s.createTime).toDateString();
                return submitDate === today;
            });
            
            return !!todaySubmission;
        }
        
        // ç”Ÿæˆé¢„çº¦å•å·
        function generateAppointmentNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const seq = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            return `YY${year}${month}${day}${seq}`;
        }
        
        // ========== é¡µé¢åˆå§‹åŒ– ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æäº¤
            if (checkDuplicateSubmission()) {
                document.getElementById('duplicateAlert').classList.add('show');
                document.getElementById('submitBtn').disabled = true;
            }
            
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨æœ€å°å’Œæœ€å¤§æ—¥æœŸ
            const dateInput = document.getElementById('visitDate');
            const today = new Date();
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 30);
            
            dateInput.min = today.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];
            
            // ========== è¡¨å•å­—æ®µäº¤äº’ ==========
            
            // å­—æ®µå¤±ç„¦éªŒè¯
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('blur', () => {
                    validateField(field);
                });
                
                // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯çŠ¶æ€
                field.addEventListener('input', () => {
                    const formGroup = field.closest('.form-group');
                    if (formGroup) formGroup.classList.remove('has-error');
                });
            });
            
            // F5: æ¥è®¿ç›®çš„æ”¹å˜æ—¶æ˜¾ç¤º/éšè—å…¶ä»–è¯´æ˜
            const visitPurpose = document.getElementById('visitPurpose');
            const otherDescGroup = document.getElementById('otherDescGroup');
            const visitPurposeDesc = document.getElementById('visitPurposeDesc');
            
            visitPurpose.addEventListener('change', function() {
                if (this.value === 'å…¶ä»–') {
                    otherDescGroup.style.display = 'block';
                    visitPurposeDesc.required = true;
                } else {
                    otherDescGroup.style.display = 'none';
                    visitPurposeDesc.required = false;
                    visitPurposeDesc.value = '';
                    otherDescGroup.querySelector('.form-group').classList.remove('has-error');
                }
            });
            
            // ========== F4: ç…§ç‰‡ä¸Šä¼ äº¤äº’ ==========
            
            const uploadBtn = document.getElementById('uploadBtn');
            const photoModal = document.getElementById('photoModal');
            const photoInput = document.getElementById('photoInput');
            const photoPreview = document.getElementById('photoPreview');
            const photoImg = document.getElementById('photoImg');
            const deletePhoto = document.getElementById('deletePhoto');
            const visitorPhoto = document.getElementById('visitorPhoto');
            
            // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ˜¾ç¤ºå¼¹çª—
            uploadBtn.addEventListener('click', () => {
                photoModal.classList.add('show');
            });
            
            // æ‹ç…§ï¼ˆæ¨¡æ‹Ÿï¼Œå®é™…æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼‰
            document.getElementById('takePhoto').addEventListener('click', () => {
                photoModal.classList.remove('show');
                photoInput.click();
            });
            
            // ä»ç›¸å†Œé€‰æ‹©
            document.getElementById('choosePhoto').addEventListener('click', () => {
                photoModal.classList.remove('show');
                photoInput.click();
            });
            
            // å–æ¶ˆ
            document.getElementById('cancelPhoto').addEventListener('click', () => {
                photoModal.classList.remove('show');
            });
            
            // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
            photoModal.addEventListener('click', (e) => {
                if (e.target === photoModal) {
                    photoModal.classList.remove('show');
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    showToast('ç…§ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼ JPGæˆ–PNGæ ¼å¼', 'error');
                    return;
                }
                
                // éªŒè¯æ–‡ä»¶å¤§å°
                if (file.size > 5 * 1024 * 1024) {
                    showToast('ç…§ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                    return;
                }
                
                // è¯»å–æ–‡ä»¶å¹¶æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoImg.src = e.target.result;
                    visitorPhoto.value = e.target.result; // å­˜å‚¨base64
                    uploadBtn.style.display = 'none';
                    photoPreview.classList.add('show');
                    
                    // æ¸…é™¤é”™è¯¯çŠ¶æ€
                    const formGroup = visitorPhoto.closest('.form-group');
                    if (formGroup) formGroup.classList.remove('has-error');
                    
                    showToast('ç…§ç‰‡ä¸Šä¼ æˆåŠŸ');
                };
                reader.readAsDataURL(file);
            });
            
            // åˆ é™¤ç…§ç‰‡
            deletePhoto.addEventListener('click', () => {
                photoImg.src = '';
                visitorPhoto.value = '';
                photoInput.value = '';
                uploadBtn.style.display = 'flex';
                photoPreview.classList.remove('show');
            });
            
            // ========== F9: è¢«è®¿äººæœç´¢äº¤äº’ ==========
            
            const visiteeSearch = document.getElementById('visiteeSearch');
            const searchList = document.getElementById('searchList');
            const selectedTag = document.getElementById('selectedTag');
            const selectedName = document.getElementById('selectedName');
            const visiteeId = document.getElementById('visiteeId');
            const clearVisitee = document.getElementById('clearVisitee');
            
            let searchTimeout;
            
            // æœç´¢è¾“å…¥
            visiteeSearch.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const keyword = this.value.trim().toLowerCase();
                
                if (!keyword) {
                    searchList.classList.remove('show');
                    return;
                }
                
                // é˜²æŠ–300ms
                searchTimeout = setTimeout(() => {
                    const results = employees.filter(emp => {
                        return emp.name.toLowerCase().includes(keyword) ||
                               emp.empNo.toLowerCase().includes(keyword) ||
                               emp.dept.toLowerCase().includes(keyword);
                    });
                    
                    if (results.length === 0) {
                        searchList.innerHTML = '<div class="search-empty">æœªæ‰¾åˆ°åŒ¹é…å‘˜å·¥ï¼Œè¯·è¾“å…¥æ›´å¤šå…³é”®è¯</div>';
                    } else {
                        searchList.innerHTML = results.slice(0, 10).map(emp => `
                            <div class="search-item" data-id="${emp.id}" data-name="${emp.name}" data-dept="${emp.dept}">
                                <span class="name">${emp.name}</span>
                                <span class="dept">${emp.dept}</span>
                                <span class="emp-no">${emp.empNo}</span>
                            </div>
                        `).join('');
                    }
                    
                    searchList.classList.add('show');
                }, 300);
            });
            
            // é€‰æ‹©å‘˜å·¥
            searchList.addEventListener('click', function(e) {
                const item = e.target.closest('.search-item');
                if (!item) return;
                
                const id = item.dataset.id;
                const name = item.dataset.name;
                const dept = item.dataset.dept;
                
                visiteeId.value = id;
                selectedName.textContent = `${name}ï¼ˆ${dept}ï¼‰`;
                selectedTag.classList.add('show');
                visiteeSearch.value = '';
                visiteeSearch.style.display = 'none';
                searchList.classList.remove('show');
                
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                const formGroup = visiteeId.closest('.form-group');
                if (formGroup) formGroup.classList.remove('has-error');
            });
            
            // æ¸…é™¤é€‰æ‹©
            clearVisitee.addEventListener('click', () => {
                visiteeId.value = '';
                selectedTag.classList.remove('show');
                visiteeSearch.style.display = 'block';
                visiteeSearch.focus();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢åˆ—è¡¨
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-wrapper')) {
                    searchList.classList.remove('show');
                }
            });
            
            // ========== è¡¨å•æäº¤ ==========
            
            const form = document.getElementById('appointmentForm');
            const submitBtn = document.getElementById('submitBtn');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // éªŒè¯è¡¨å•
                if (!validateForm()) {
                    showToast('è¯·æ£€æŸ¥è¡¨å•å¡«å†™æ˜¯å¦æ­£ç¡®', 'error');
                    return;
                }
                
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = new FormData(form);
                const data = {
                    visitorName: formData.get('visitorName'),
                    visitorPhone: formData.get('visitorPhone'),
                    visitorIdCard: formData.get('visitorIdCard'),
                    visitorPhoto: formData.get('visitorPhoto'),
                    visitPurpose: formData.get('visitPurpose'),
                    visitPurposeDesc: formData.get('visitPurposeDesc') || '',
                    visitDate: formData.get('visitDate'),
                    visitTimeSlot: formData.get('visitTimeSlot'),
                    visiteeId: formData.get('visiteeId'),
                    visiteeName: selectedName.textContent
                };
                
                console.log('æäº¤çš„æ•°æ®ï¼š', data);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoading(true);
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼ˆ2ç§’å»¶è¿Ÿï¼‰
                setTimeout(() => {
                    // ç”Ÿæˆé¢„çº¦å•å·
                    const appointmentNumber = generateAppointmentNumber();
                    
                    // ä¿å­˜åˆ°localStorage
                    const appointment = {
                        ...data,
                        appointmentNumber,
                        status: 'å¾…å®¡æ‰¹',
                        createTime: new Date().toISOString()
                    };
                    
                    const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    appointments.push(appointment);
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    localStorage.setItem('latestAppointment', JSON.stringify(appointment));
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    showLoading(false);
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast('æäº¤æˆåŠŸ');
                    
                    // 1ç§’åè·³è½¬åˆ°æˆåŠŸé¡µ
                    setTimeout(() => {
                        window.location.href = `P2-é¢„çº¦æäº¤æˆåŠŸé¡µ.html?id=${appointmentNumber}`;
                    }, 1000);
                }, 2000);
            });
        });
    </script>
</body>
</html>
